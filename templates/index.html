<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons.png') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0 auto;
            padding: 0;
            min-width: 100vw;

        }

        .nav {
            margin-bottom: 20px;
            white-space: nowrap;
        }

        .nav a {
            display: inline-block;
            margin-right: 10px;
            padding: 12px 20px;
            font-size: 16px;
            background-color: #e0e0e0;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: all 0.2s ease;
            white-space: nowrap; /* üëà –≠–¢–û –ù–ï –î–ê–°–¢ –°–õ–û–í–ê–ú –ü–ï–†–ï–ù–û–°–ò–¢–¨–°–Ø */
        }

        .nav a:hover {
            transform: scale(1.05);
        }

        .nav a.active {
            background-color: #007bff;
            color: white;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
        }

        td, th {
            height: 25px;
            vertical-align: middle;
            padding: 4px 6px;
            border: 1px solid #ccc;
            text-align: left;
            white-space: nowrap;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        h3 {
            margin-top: 30px;
        }
        th a {
            color: black;
            text-decoration: none;
        }

        th a:visited {
            color: black;
        }

        th a:hover {
            color: black;
            text-decoration: none;
        }
        .text-muted {
            color: #888;
        }
        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            table-layout: auto;
        }

        th:first-child {
            border-top-left-radius: 10px;
        }

        th:last-child {
            border-top-right-radius: 10px;
        }

        tr:last-child td:first-child {
            border-bottom-left-radius: 10px;
        }

        tr:last-child td:last-child {
            border-bottom-right-radius: 10px;
        }
        td {
            width: 140px; /* –ª–∏–±–æ auto, –ª–∏–±–æ –ø–æ–¥–±–µ—Ä–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –ø–æ–¥ –≤–∞—à –∫–æ–Ω—Ç–µ–Ω—Ç */
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 4px 6px;
        }

        td input {
            width: 100%;
            box-sizing: border-box;
            height: 100%;
            padding: 0 4px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        td, th {
            height: 25px;
            max-height: 30px;
            padding: 4px 6px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        td input {
            height: 100%;
            width: 100%;
            padding: 2px 4px;
            font-size: 14px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            line-height: 1;
        }

        td.text-left {
            min-width: 270px;
            max-width: 270px;
            width: 270px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td.text-left input {
            width: 100%;
            min-width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            padding: 2px 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        td.text-center input,
        td.text-center select {
            text-align: center;
        }
        td select {
            height: 100%;
            width: 100%;
            padding: 2px 4px;
            font-size: 14px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg fill='gray' height='14' viewBox='0 0 24 24' width='14' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 16px;
            padding-right: 24px;
            line-height: 1;
        }
        .header-yandex th {
            background-color: #fdf7b2;
        }

        .header-ozon th {
            background-color: #d5e4ff;
            color: black;
        }

        .header-wildberries th {
            background-color: #efc1ed;
            color: black;
        }

        .nav a.active.yandex {
            background-color: #fdf7b2;
            color: black;
        }

        .nav a.active.ozon {
            background-color: #d5e4ff;
            color: black;
        }

        .nav a.active.wildberries {
            background-color: #efc1ed;
            color: black;
        }
        .add-button-yandex {
            background-color: #fdf7b2;
            color: black;
        }

        .add-button-ozon {
            background-color: #d5e4ff;
            color: black;
        }

        .add-button-wildberries {
            background-color: #efc1ed;
            color: black;
        }
        .stats-yandex {
            background-color: #fff8dc;
        }

        .stats-ozon {
            background-color: #e0ffff;
        }

        .stats-wildberries {
            background-color: #f3e6ff;
        }
        #manual-update-btn {
            transition: all 0.2s ease;
            transform-origin: left center;
        }

        #manual-update-btn:hover {
            transform: scale(1.1);
            color: #0056b3;
            text-decoration: none; /* —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
        }
        .toggle-switch {
          position: relative;
          display: inline-block;
          width: 26px;
          height: 14px;
        }
        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .toggle-slider {
          position: absolute;
          cursor: pointer;
          top: 0; left: 0;
          right: 0; bottom: 0;
          background-color: #ccc;
          transition: .3s;
          border-radius: 14px;
        }
        .toggle-slider:before {
          position: absolute;
          content: "";
          height: 10px;
          width: 10px;
          left: 2px;
          bottom: 2px;
          background-color: white;
          transition: .3s;
          border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
          background-color: #3395ff;
        }
        .toggle-switch input:checked + .toggle-slider:before {
          transform: translateX(12px);
        }
        tr.highlighted {
            background-color: var(--highlight-color) !important;
        }
        td[title] {
    position: relative;
    cursor: default;
        }

        td[title]:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 0;
            white-space: normal;
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 999;
            max-width: 500px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        td.comment-cell {
            min-width: 210px;
            max-width: 210px;
            width: 210px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td.comment-cell input {
            width: 100%;
            min-width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            padding: 2px 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .top-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .table-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: -33px;
        }
        table {
            display: inline-table;
            margin: 0 auto;
        }
        input[type="search"]::-webkit-search-cancel-button {
            display: none;
        }
        .letter-filter a {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            text-decoration: none;
            color: #333;
            transition: all 0.2s ease;
        }

        .letter-filter a:hover {
            background-color: #f0f0f0;
        }

        .letter-filter a.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        html, body {
            width: max-content;     /* —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É */
            overflow-x: auto;       /* –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
            overflow-y: auto;     /* —Å–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω */
            height: 100%;
        }
        /* –î–û–ë–ê–í–¨ –≤ –∫–æ–Ω–µ—Ü —Ç–æ–≥–æ –∂–µ <style>, –≥–¥–µ —É–∂–µ –ª–µ–∂–∏—Ç –º–æ–±–∏–ª—å–Ω—ã–π –º–µ–¥–∏–∞–∑–∞–ø—Ä–æ—Å */
        /* --- –ú–æ–±–∏–ª—å–Ω—ã–π —Ñ–∏–∫—Å (‚â§ 767 px) ----------------------------------- */
        @media (max-width: 767px){
            html, body{
                 height: auto;     /* —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–∂–µ—Ç —Ä–∞—Å—Ç–∏ –≤–Ω–∏–∑ */
                 min-height: 100vh;/* –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ –≤—ã—Å–æ—Ç—ã –≤–∏–¥–∏–º–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ */
             }

          /* 1. –û–±–Ω—É–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã  */
          .table-container{
              justify-content: flex-start;   /* –≤–º–µ—Å—Ç–æ center */
              overflow-x: auto;              /* —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–ª–æ—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
              /* 2. ¬´–í—ã—Ç—è–≥–∏–≤–∞–µ–º¬ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É,
                    –Ω–µ —Ç—Ä–æ–≥–∞—è padding —É .wrapper */
              margin-left: -20px;            /* —Å—ä–µ–¥–∞–µ–º –ª–µ–≤—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø wrapper */
              margin-right: -20px;           /* ‚Ä¶–∏ –ø—Ä–∞–≤—ã–π */
              padding-left: 20px;            /* –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ¬´–±—É—Ñ–µ—Ä¬ª, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –ª–∏–ø –∫ –∫—Ä–∞—é */
              padding-right: 20px;
          }

          /* 3. –¢–∞–±–ª–∏—Ü–∞ –±–µ–∑ margin:auto, —á—Ç–æ–±—ã –Ω–µ —É–±–µ–≥–∞–ª–∞ –≤–ø—Ä–∞–≤–æ */
          .table-container > table{
              margin: 0;
          }
        }
    </style>
</head>
<body>
<div class="wrapper">
    <div class="top-panel" style="
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        gap: 60px;  /* ‚úÖ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤—Å–µ–º–∏ –±–ª–æ–∫–∞–º–∏ */
        flex-wrap: wrap;
    ">
      <!-- –ë–ª–æ–∫–∏ "Sklad –æ–±–Ω–æ–≤–ª–µ–Ω" –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
      <div style="display: flex; gap: 30px; align-items: flex-start;">
        {% if last_download_time %}
        <div style="font-size: 15px; color: #555; display: flex; flex-direction: column; gap: 6px; min-width: 200px;">
          <div style="font-weight: normal;">Sklad –æ–±–Ω–æ–≤–ª–µ–Ω:</div>
          <div>{{ last_download_time }}</div>
          <div style="font-size: 15px; color: #007bff; cursor: pointer;" id="manual-update-btn">
            –û–±–Ω–æ–≤–∏—Ç—å
          </div>
        </div>
        {% endif %}

        {% if stats %}
        <div style="font-size: 15px; color: #555; display: flex; flex-direction: column; gap: 6px; min-width: 160px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:</span>
            <span>{{ stats['–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤'] }}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span>–í –Ω–∞–ª–∏—á–∏–∏:</span>
            <span>{{ stats['–í –Ω–∞–ª–∏—á–∏–∏'] }}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span>–û—Ç–∫–ª—é—á–µ–Ω–æ:</span>
            <span>{{ stats['–û—Ç–∫–ª—é—á–µ–Ω–æ'] }}</span>
          </div>
        </div>
        {% endif %}
      </div>
      <!-- –ü—Ä–∞–≤—ã–π –±–ª–æ–∫ —Å –≤—ã–∫–ª—é—á–∞—Ç–µ–ª—è–º–∏ -->
      <div class="nav" style="display: flex; gap: 6px; align-items: center; margin-top: 19px;">
        <a href="/table/yandex" class="{% if selected_table == 'yandex' %}active yandex{% endif %}">Yandex</a>
        <a href="/table/ozon" class="{% if selected_table == 'ozon' %}active ozon{% endif %}">Ozon</a>
        <a href="/table/wildberries" class="{% if selected_table == 'wildberries' %}active wildberries{% endif %}">Wildberries</a>
      </div>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ -->
      <div style="font-size: 15px; color: #555; display: flex; flex-direction: column; gap: 6px; min-width: 120px;">
        {% for mp in ['yandex', 'ozon', 'wildberries'] %}
        <label style="display: flex; align-items: center; justify-content: space-between;">
          <span style="min-width: 90px;">{{ mp.capitalize() }}</span>
          <label class="toggle-switch">
            <input type="checkbox" data-market="{{ mp }}" class="global-toggle" {% if global_stock_flags[mp] %}checked{% endif %}>
            <span class="toggle-slider"></span>
          </label>
        </label>
        {% endfor %}
      </div>
      <!-- –ö–Ω–æ–ø–∫–∞ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" -->
      <div style="margin-top: 19px;">
          <a href="/statistic"
             style="display: flex; align-items: center; gap: 6px;
                    padding: 6px 12px; font-size: 15px;
                    border-radius: 6px; border: 1px solid #ccc;
                    background-color: #f0f0f0;
                    color: #333; text-decoration: none;
                    transition: all 0.2s;">
            <img src="{{ url_for('static', filename='icons/stats.svg') }}" alt="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" width="16" height="16">
            –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
          </a>
        </div>


        <!-- –ë–ª–æ–∫ –ø–æ–∏—Å–∫–∞ + –∞–ª—Ñ–∞–≤–∏—Ç -->
        <div style="display: flex; align-items: center; gap: 100px; flex-wrap: wrap; margin-top: -55px;">

          <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Ñ–æ—Ä–º–∞ -->
          <form method="GET" action="/table/{{ selected_table }}" style="display: flex; align-items: center; gap: 10px; margin-left: 60px;">
            <div style="position: relative;">
              <input type="search" id="custom-search" name="search"
                     placeholder="–ü–æ–∏—Å–∫: –ê—Ä—Ç_MC, –ü–æ—Å—Ç–∞–≤—â–∏–∫, –ú–æ–¥–µ–ª—å"
                     value="{{ request.args.get('search', '') }}"
                     style="font-size: 15px; padding: 6px 32px 6px 12px; border-radius: 6px;
                            width: 310px; box-sizing: border-box; border: 1px solid #ccc;"
                     onsearch="this.value=''; this.form.submit();">
              <span id="clear-search"
                    style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
                           cursor: pointer; font-size: 16px; color: #aaa; display: none;">&times;</span>
            </div>
            <button type="submit"
                    style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 15px;
                           border-radius: 6px; border: 1px solid #ccc; background-color: #f0f0f0;
                           cursor: pointer; transition: all 0.2s;">
              <img src="{{ url_for('static', filename='icons/search.svg') }}" alt="üîç" width="16" height="16">
              –ù–∞–π—Ç–∏
            </button>
          </form>

          <!-- –ê–ª—Ñ–∞–≤–∏—Ç -->
          <div class="letter-filter" style="display: flex; flex-direction: column; gap: 6px; margin-top: 2px;">
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
              {% set row1 = ['0-9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M'] %}
              {% for letter in row1 %}
                <a href="{{ url_for('show_table', table_name=selected_table, letter=letter, search=request.args.get('search', '')) }}"
                   class="{% if request.args.get('letter') == letter %}active{% endif %}">
                  {{ letter }}
                </a>
              {% endfor %}
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
              {% set row2 = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '–ê-–Ø'] %}
              {% for letter in row2 %}
                <a href="{{ url_for('show_table', table_name=selected_table, letter=letter, search=request.args.get('search', '')) }}"
                   class="{% if request.args.get('letter') == letter %}active{% endif %}">
                  {{ letter }}
                </a>
              {% endfor %}
            </div>
          </div>
        </div>
        {% if table_data is not none %}
            <div class="table-container">
                 <table>
                    <thead class="header-{{ selected_table }}">
                        <tr>
                            {% for col in table_data.columns %}
                                <th class="{% if col.strip() == '–ú–æ–¥–µ–ª—å' %}text-left{% else %}text-center{% endif %}">
                                    <a href="/table/{{ selected_table }}?sort={{ col }}&order={% if sort_column == col and sort_order == 'asc' %}desc{% else %}asc{% endif %}">
                                        {{ col }}
                                    </a>
                                </th>
                            {% endfor %}
                            <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                        <tr>
                            <form method="POST" action="/add/{{ selected_table }}">
                                {% for col in table_data.columns %}
                                    <td class="{% if col.strip() == '–ú–æ–¥–µ–ª—å' %}text-left{% else %}text-center{% endif %}">
                                        {% if col.strip() not in ['‚Ññ', '–¶–µ–Ω–∞ YM', '–¶–µ–Ω–∞ OZ', '–¶–µ–Ω–∞ WB'] %}
                                            {% if col.strip() == '–ü–æ—Å—Ç–∞–≤—â–∏–∫' %}
                                                <select name="–ü–æ—Å—Ç–∞–≤—â–∏–∫">
                                                    <option value=""></option>
                                                    <option value="Sklad">Sklad</option>
                                                    <option value="United">United</option>
                                                    <option value="Invask">Invask</option>
                                                    <option value="Okno">Okno</option>
                                                </select>
                                            {% elif col.strip() == '–°—Ç–∞—Ç—É—Å' %}
                                                <select name="–°—Ç–∞—Ç—É—Å">
                                                    <option value=""></option>
                                                    <option value="–≤—ã–∫–ª.">–≤—ã–∫–ª.</option>
                                                </select>
                                            {% else %}
                                                <input type="text" name="{{ col }}"
                                                    {% if col in ['–ù–∞–ª', '–û–ø—Ç', '–ù–∞—Ü–µ–Ω–∫–∞', '–ê—Ä—Ç_MC', 'WB Barcode', 'WB –ê—Ä—Ç–∏–∫—É–ª'] %}
                                                        inputmode="numeric" pattern="\d*" maxlength="20"
                                                        oninput="this.value = this.value.replace(/\D/g, '')"
                                                    {% endif %}
                                                >
                                            {% endif %}
                                        {% else %}
                                            <!-- –≤—ã—á–∏—Å–ª—è–µ–º–æ–µ –ø–æ–ª–µ -->
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <td class="text-center">
                                    <button type="submit" title="–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä"
                                        class="add-button-{{ selected_table }}"
                                        style="
                                            border: none;
                                            padding: 6px 12px;
                                            border-radius: 5px;
                                            cursor: pointer;
                                            font-size: 14px;
                                        ">
                                        –î–æ–±–∞–≤–∏—Ç—å
                                    </button>
                                </td>
                            </form>
                        </tr>
                    </thead>


                    <tbody>
                        {% for row in table_data.values.tolist() %}
                        <tr>
                            {% for col, item in zip(table_data.columns, row) %}
                                {% set value = item if item is not none else '' %}
                                <td class="{% if col.strip() == '–ú–æ–¥–µ–ª—å' %}text-left{% elif col.strip() == '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' %}comment-cell{% else %}text-center{% endif %}{% if col.strip() in ['–ü–æ—Å—Ç–∞–≤—â–∏–∫', '–ê—Ä—Ç–∏–∫—É–ª'] %} text-muted{% endif %}"
                                    {% if col.strip() in ['–ú–æ–¥–µ–ª—å', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'] and value|length > 35 %}title="{{ value }}"{% endif %}>
                                    {% if col.strip() in ['–û–ø—Ç', '–¶–µ–Ω–∞ YM', '–¶–µ–Ω–∞ OZ', '–¶–µ–Ω–∞ WB'] %}
                                        {% if value is number %}
                                            {{ '{:,.0f} —Ä.'.format(value).replace(',', ' ') }}
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    {% elif col.strip() == '–ù–∞—Ü–µ–Ω–∫–∞' %}
                                        {{ value }} %
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                </td>
                            {% endfor %}
                            <td class="text-center action-cell">
                                <button type="button" class="edit-btn" style="border:none; background:none; cursor:pointer;">
                                    <img src="{{ url_for('static', filename='icons/file-edit.svg') }}" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" width="18">
                                </button>
                                <form method="post" action="/delete/{{ selected_table }}/{{ row[table_data.columns.get_loc('–ê—Ä—Ç–∏–∫—É–ª')] }}" class="delete-form" style="display:inline;">
                                    <input type="hidden" name="item_name" value="{{ row[table_data.columns.get_loc('–ú–æ–¥–µ–ª—å')] }}">
                                    <button type="button" class="delete-btn" style="border:none; background:none; cursor:pointer;">
                                        <img src="{{ url_for('static', filename='icons/trash.svg') }}" alt="–£–¥–∞–ª–∏—Ç—å" width="18">
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% endif %}
</div>
    <script src="{{ url_for('static', filename='js/sweetalert2.all.min.js') }}"></script>
    <script>
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const form = this.closest('form');
            const itemName = form.querySelector('input[name="item_name"]').value;

            Swal.fire({
                title: `–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${itemName}"?`,
                text: "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#aaa',
                confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
                cancelButtonText: '–û—Ç–º–µ–Ω–∞'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });
    </script>
    <script>
    document.querySelectorAll('.edit-btn').forEach(function(button) {
        button.addEventListener('click', function () {
            const row = this.closest('tr');

            const table = "{{ selected_table }}";
            const headers = {{ table_data.columns.tolist() | tojson }};
            const cells = row.querySelectorAll('td');
            const indexOfArtMC = headers.indexOf("–ê—Ä—Ç_MC");
            const itemId = cells[indexOfArtMC].innerText.trim();


            const numericFields = ['–û–ø—Ç', '–¶–µ–Ω–∞ YM', '–¶–µ–Ω–∞ OZ', '–¶–µ–Ω–∞ WB', '–ù–∞—Ü–µ–Ω–∫–∞', '–ù–∞–ª'];
            const recalcPrices = () => {
                const optInput = row.querySelector('input[name="–û–ø—Ç"]');
                const markupInput = row.querySelector('input[name="–ù–∞—Ü–µ–Ω–∫–∞"]');

                const opt = parseFloat(optInput?.value.replace(/\s/g, ''));
                const markup = parseFloat(markupInput?.value.replace(/\s/g, ''));

                if (!isNaN(opt) && !isNaN(markup)) {
                    const newPrice = Math.round(opt + (opt * markup / 100));
                    ['–¶–µ–Ω–∞ YM', '–¶–µ–Ω–∞ OZ', '–¶–µ–Ω–∞ WB'].forEach(field => {
                        const td = row.querySelector(`td[data-price-target="${field}"]`);
                        if (td) {
                            td.innerText = newPrice.toLocaleString('ru-RU') + ' —Ä.';
                        }
                    });
                }
            };

            // –ó–∞–º–µ–Ω—è–µ–º td –Ω–∞ input'—ã
            for (let i = 0; i < headers.length; i++) {
                const td = cells[i];
                if (['–ú–æ–¥–µ–ª—å', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'].includes(headers[i].trim())) {
                    td.classList.add('text-left');
                    td.classList.remove('text-center');
                } else {
                    td.classList.add('text-center');
                    td.classList.remove('text-left');
                }
                const val = td.innerText.trim();

                const skipInputFields = ['‚Ññ', '–¶–µ–Ω–∞ YM', '–¶–µ–Ω–∞ OZ', '–¶–µ–Ω–∞ WB'];
                if (!headers[i] || skipInputFields.includes(headers[i])) {
                    if (['–¶–µ–Ω–∞ YM', '–¶–µ–Ω–∞ OZ', '–¶–µ–Ω–∞ WB'].includes(headers[i])) {
                        td.setAttribute('data-price-target', headers[i]); // üí° –ø–æ–º–µ—á–∞–µ–º td
                    }
                    continue;
                }
                td.style.width = td.offsetWidth + 'px';
                td.innerHTML = '';
                let input;
                if (headers[i] === '–ü–æ—Å—Ç–∞–≤—â–∏–∫') {
                    input = document.createElement('select');
                    input.name = '–ü–æ—Å—Ç–∞–≤—â–∏–∫';
                    ['','Sklad','United','Invask','Okno'].forEach(optVal => {
                        const option = document.createElement('option');
                        option.value = optVal;
                        option.textContent = optVal;
                        if (optVal === val) option.selected = true;
                        input.appendChild(option);
                    });
                } else if (headers[i] === '–°—Ç–∞—Ç—É—Å') {
                    input = document.createElement('select');
                    input.name = '–°—Ç–∞—Ç—É—Å';
                    ['','–≤—ã–∫–ª.'].forEach(optVal => {
                        const option = document.createElement('option');
                        option.value = optVal;
                        option.textContent = optVal;
                        if (optVal === val) option.selected = true;
                        input.appendChild(option);
                    });
                } else {
                    input = document.createElement('input');
                    if (headers[i] === '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π') {
                        td.classList.add('comment-cell');
                        input.style.minWidth = '210px';
                        input.style.maxWidth = '280px';
                    }
                    input.name = headers[i];
                    if (headers[i] === '–ù–∞–ª') {
                        const onoffSelect = row.querySelector('select[name="–°—Ç–∞—Ç—É—Å"]');
                        if (onoffSelect && onoffSelect.value === '–≤—ã–∫–ª.') {
                            input.value = '0';
                            input.disabled = true;
                        }
                    }
                    if (numericFields.includes(headers[i])) {
                        input.value = val.replace(/\s/g, '').replace('—Ä.', '').replace('%', '');
                    } else {
                        input.value = val;
                    }
                    input.style.width = '100%';
                    input.type = 'text';
                    if (numericFields.includes(headers[i])) {
                        input.inputMode = 'numeric';
                        input.pattern = '\\d*';
                        input.addEventListener('input', function () {
                            this.value = this.value.replace(/[^\d]/g, '');
                        });
                        input.addEventListener('paste', function (e) {
                            e.preventDefault();
                        });
                        input.addEventListener('drop', function (e) {
                            e.preventDefault();
                        });
                        if (['–û–ø—Ç', '–ù–∞—Ü–µ–Ω–∫–∞'].includes(headers[i])) {
                            input.addEventListener('input', recalcPrices);
                        }
                    }
                }
                td.appendChild(input);

            }
            const onoffSelect = row.querySelector('select[name="–°—Ç–∞—Ç—É—Å"]');
            const stockInput = row.querySelector('input[name="–ù–∞–ª"]');
            if (onoffSelect && stockInput) {
                onoffSelect.addEventListener('change', function () {
                    if (this.value === '–≤—ã–∫–ª.') {
                        stockInput.value = '0';
                        stockInput.disabled = true;
                    } else {
                        stockInput.disabled = false;
                    }
                });
            }
            // üõ°Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª submit –¥–≤–∞–∂–¥—ã
            const addForm = document.querySelector('form[action^="/add"]');
            if (addForm && addForm.parentNode) {
                addForm.parentNode.removeChild(addForm);
            }
            // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/update/${table}/${itemId}`;
            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = '–ê—Ä—Ç_MC';
            hiddenId.value = itemId;
            form.appendChild(hiddenId);
            form.style.display = 'inline';

            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ENTER ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
            cells.forEach((td, i) => {
                const input = td.querySelector('input');
                if (!input) return;

                input.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        form.requestSubmit();
                    }
                });
            });

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º submit: –¥–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                let valid = true;
                let invalidFields = [];

                // üîß –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ hidden –ø–æ–ª—è, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
                form.querySelectorAll('input[type="hidden"]').forEach(el => el.remove());

                for (let i = 0; i < headers.length; i++) {
                    if (!headers[i] || headers[i] === '‚Ññ') continue;

                    const element = cells[i].querySelector('input, select');
                    if (element) {
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = headers[i];
                        let value = element.value.trim();

                        if (numericFields.includes(headers[i])) {
                            value = value.replace(/\s+/g, '').replace('—Ä.', '').replace('%', '').trim();
                            if (!value || !/^\d+$/.test(value)) {
                                valid = false;
                                invalidFields.push(headers[i]);
                            }
                        }

                        hidden.value = value;
                        form.appendChild(hidden);
                    }
                }

                if (!valid) {
                    Swal.fire({
                        icon: 'error',
                        title: '–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞',
                        text: '–ü–æ–ª—è: ' + invalidFields.join(', ') + ' –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.',
                    });
                    return;
                }

                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form)
                }).then(response => {
                    if (response.ok) {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        setTimeout(() => location.reload(), 500);
                    } else {
                        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
                    }
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
                    Swal.fire('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
                });
            });
            const editBtn = row.querySelector('.edit-btn');
            if (editBtn) {
                const parentCell = editBtn.closest('td');

                // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É ‚úèÔ∏è
                editBtn.remove();

                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "–≥–∞–ª–æ—á–∫–∞"
                const saveBtn = document.createElement('button');
                saveBtn.type = 'submit';
                saveBtn.innerText = '‚úÖ';
                saveBtn.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                saveBtn.style = 'background:none; border:none; color:green; cursor:pointer; font-size:18px;';

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ñ–æ—Ä–º—É
                form.appendChild(saveBtn);

                // –í—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –Ω–∞ –º–µ—Å—Ç–æ, –≥–¥–µ –±—ã–ª–∞ –∫–Ω–æ–ø–∫–∞ ‚úèÔ∏è
                parentCell.insertBefore(form, parentCell.firstChild);
            }
        });
    });
    </script>

    <script>
        // ‚¨á –°–æ—Ö—Ä–∞–Ω—è–µ–º scrollY –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
        window.addEventListener("beforeunload", function () {
            localStorage.setItem("scrollY", window.scrollY);
        });

        // ‚¨Ü –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º scrollY –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        window.addEventListener("DOMContentLoaded", function () {
            const y = localStorage.getItem("scrollY");
            if (y !== null) {
                setTimeout(() => {
                    window.scrollTo(0, parseInt(y));
                    localStorage.removeItem("scrollY");
                }, 0); // –æ—Ç–ª–æ–∂–∏–º –Ω–∞ 1 tick
            }
        });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const addForm = document.querySelector('form[action^="/add"]');
        if (!addForm) return;

        const requiredFields = ['–ê—Ä—Ç_MC', '–ü–æ—Å—Ç–∞–≤—â–∏–∫', '–ê—Ä—Ç–∏–∫—É–ª', '–ú–æ–¥–µ–ª—å', '–ù–∞–ª', '–û–ø—Ç', '–ù–∞—Ü–µ–Ω–∫–∞'];

        addForm.addEventListener("submit", function (e) {
            const formData = new FormData(addForm);
            let hasError = false;
            let missingFields = [];
            let invalidNumericFields = [];

            requiredFields.forEach(field => {
                const value = formData.get(field)?.trim();
                if (!value) {
                    hasError = true;
                    missingFields.push(field);
                } else if (['–ù–∞–ª', '–û–ø—Ç', '–ù–∞—Ü–µ–Ω–∫–∞', '–ê—Ä—Ç_MC', 'WB Barcode', 'WB –ê—Ä—Ç–∏–∫—É–ª'].includes(field) && !/^\d+$/.test(value)) {
                    hasError = true;
                    invalidNumericFields.push(field);
                }
            });

            if (hasError) {
                e.preventDefault();
                let msg = '';
                if (missingFields.length > 0) {
                    msg += `–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è: ${missingFields.join(', ')}.\n`;
                }
                if (invalidNumericFields.length > 0) {
                    msg += `–ü–æ–ª—è ${invalidNumericFields.join(', ')} –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.`;
                }

                Swal.fire({
                    icon: 'error',
                    title: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞',
                    text: msg,
                });
            }
        });

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –±—É–∫–≤—ã –≤ —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª—è—Ö
        ['–ù–∞–ª', '–û–ø—Ç', '–ù–∞—Ü–µ–Ω–∫–∞', '–ê—Ä—Ç_MC', 'WB Barcode', 'WB –ê—Ä—Ç–∏–∫—É–ª'].forEach(field => {
            const input = addForm.querySelector(`input[name="${field}"]`);
            if (input) {
                input.addEventListener("input", function () {
                    this.value = this.value.replace(/\D/g, '');
                });
            }
        });
    });
    </script>

    <script>
    document.getElementById('manual-update-btn')?.addEventListener('click', function () {
        const btn = this;
        btn.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶";
        btn.style.pointerEvents = "none";
        btn.style.opacity = "0.6";

        fetch('/run_update', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞.");
                btn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å";
                btn.style.pointerEvents = "";
                btn.style.opacity = "";
            }
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞:", err);
            alert("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–∫–ª–∞–¥.");
            btn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å";
            btn.style.pointerEvents = "";
            btn.style.opacity = "";
        });
    });
    </script>
    <script>
    document.querySelectorAll('.global-toggle').forEach(input => {
        input.addEventListener('change', function () {
            const market = this.dataset.market;
            fetch(`/toggle_stock/${market}`, {
                method: 'POST'
            }).then(() => {
                location.reload();
            }).catch(() => {
                alert("‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–∫–ª–∞–¥–∞");
            });
        });
    });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const rows = document.querySelectorAll("tbody tr");
        const selectedTable = "{{ selected_table }}";
        let color = "#fdf7b2";  // Yandex –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

        if (selectedTable === "ozon") color = "#d5e4ff";
        if (selectedTable === "wildberries") color = "#efc1ed";

        rows.forEach(row => {
            row.addEventListener("click", function () {
                rows.forEach(r => r.classList.remove("highlighted"));  // —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä–æ–µ
                this.classList.add("highlighted");
                this.style.setProperty('--highlight-color', color);
            });
        });
    });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("td.text-left").forEach(td => {
            if (td.scrollWidth > td.clientWidth) {
                td.setAttribute("title", td.textContent.trim());
            }
        });
    });
    </script>

    {% if request.args.get('duplicate') %}
    <script>
        Swal.fire({
            icon: 'error',
            title: '–û—à–∏–±–∫–∞!',
            text: '‚ùå –¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º –ê—Ä—Ç_MC –∏–ª–∏ –ê—Ä—Ç–∏–∫—É–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ù—É–∂–Ω—ã —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.',
            confirmButtonColor: '#007bff'
        });
    </script>
    {% endif %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("custom-search");
  const clearBtn = document.getElementById("clear-search");
  const form = input.closest("form");

  if (!input || !clearBtn || !form) return;

  const toggleClearBtn = () => {
    if (input.value.trim()) {
      clearBtn.style.display = "block";
    } else {
      clearBtn.style.display = "none";
    }
  };

  // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –∫—Ä–µ—Å—Ç–∏–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
  input.addEventListener("input", toggleClearBtn);
  toggleClearBtn(); // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

  // –ö–ª–∏–∫ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É ‚Äî –æ—á–∏—Å—Ç–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
  clearBtn.addEventListener("click", function () {
    input.value = "";
    toggleClearBtn();
    form.submit();  // —Å–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞
  });

  // –ù–∞–∂–∞—Ç–∏–µ Enter ‚Äî –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞
  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      form.submit();
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".letter-filter a").forEach(link => {
        link.addEventListener("click", function (e) {
            const currentLetter = new URLSearchParams(window.location.search).get("letter");
            const thisLetter = this.textContent.trim();

            if (currentLetter === thisLetter) {
                e.preventDefault();
                const url = new URL(window.location.href);
                url.searchParams.delete("letter");
                window.location.href = url.toString(); // ‚ùå —Å–Ω–∏–º–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
            }
        });
    });
});
</script>

</body>
</html>
