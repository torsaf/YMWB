<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–∞–±–ª–∏—Ü</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='icons.png') }}">
    <meta name="viewport" content="width=1600">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0 auto;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        .nav {
            margin-bottom: 20px;
            white-space: nowrap;
        }

        .nav a {
            display: inline-block;
            margin-right: 10px;
            padding: 12px 20px;
            font-size: 16px;
            background-color: #e0e0e0;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            transition: all 0.2s ease;
            white-space: nowrap; /* üëà –≠–¢–û –ù–ï –î–ê–°–¢ –°–õ–û–í–ê–ú –ü–ï–†–ï–ù–û–°–ò–¢–¨–°–Ø */
        }

        .nav a:hover {
            transform: scale(1.05);
        }

        .nav a.active {
            background-color: #007bff;
            color: white;
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        h3 {
            margin-top: 30px;
        }
        th a {
            color: black;
            text-decoration: none;
        }

        th a:visited {
            color: black;
        }

        th a:hover {
            color: black;
            text-decoration: none;
        }
        .text-muted {
            color: #888;
        }
        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            table-layout: auto;
        }


        td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 4px 6px;
        }

        td input {
            width: 100%;
            box-sizing: border-box;
            height: 100%;
            padding: 0 4px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        td, th {
            height: 24px;                 /* –±—ã–ª–æ 25px */
            max-height: 27px;             /* –±—ã–ª–æ 30px */
            padding: 3px 5px;             /* –±—ã–ª–æ 4px 6px */
            border: 1px solid #ccc;
            vertical-align: middle;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 90%;
        }
        td input {
            height: 100%;
            width: 100%;
            padding: 2px 4px;
            font-size: 14px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            line-height: 1;
        }

        td.text-left {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td.text-left input {
            width: 100%;
            min-width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            padding: 2px 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        td.text-center input,
        td.text-center select {
            text-align: center;
        }
        td select {
            height: 100%;
            width: 100%;
            padding: 2px 4px;
            font-size: 14px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: white;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg fill='gray' height='14' viewBox='0 0 24 24' width='14' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            background-size: 16px;
            padding-right: 24px;
            line-height: 1;
        }
        .header-yandex th {
            background-color: #fdf7b2;
        }

        .header-ozon th {
            background-color: #d5e4ff;
            color: black;
        }

        .header-wildberries th {
            background-color: #efc1ed;
            color: black;
        }

        .header-yandex .header-cell {
            background-color: #fdf7b2;
            color: black;
        }

        .header-ozon .header-cell {
            background-color: #d5e4ff;
            color: black;
        }

        .header-wildberries .header-cell {
            background-color: #efc1ed;
            color: black;
        }

        .nav a.active.yandex {
            background-color: #fdf7b2;
            color: black;
        }

        .nav a.active.ozon {
            background-color: #d5e4ff;
            color: black;
        }

        .nav a.active.wildberries {
            background-color: #efc1ed;
            color: black;
        }
        .add-button-yandex {
            background-color: #fdf7b2;
            color: black;
        }

        .add-button-ozon {
            background-color: #d5e4ff;
            color: black;
        }

        .add-button-wildberries {
            background-color: #efc1ed;
            color: black;
        }
        .stats-yandex {
            background-color: #fff8dc;
        }

        .stats-ozon {
            background-color: #e0ffff;
        }

        .stats-wildberries {
            background-color: #f3e6ff;
        }
        #manual-update-btn {
            transition: all 0.2s ease;
            transform-origin: left center;
        }

        #manual-update-btn:hover {
            transform: scale(1.1);
            color: #0056b3;
            text-decoration: none; /* —É–±–∏—Ä–∞–µ–º –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ */
        }
        .toggle-switch {
          position: relative;
          display: inline-block;
          width: 26px;
          height: 14px;
        }
        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }
        .toggle-slider {
          position: absolute;
          cursor: pointer;
          top: 0; left: 0;
          right: 0; bottom: 0;
          background-color: #ccc;
          transition: .3s;
          border-radius: 14px;
        }
        .toggle-slider:before {
          position: absolute;
          content: "";
          height: 10px;
          width: 10px;
          left: 2px;
          bottom: 2px;
          background-color: white;
          transition: .3s;
          border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider {
          background-color: #3395ff;
        }
        .toggle-switch input:checked + .toggle-slider:before {
          transform: translateX(12px);
        }
        tr.highlighted {
            background-color: var(--highlight-color) !important;
        }
        td[title] {
    position: relative;
    cursor: default;
        }

        td[title]:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 0;
            white-space: normal;
            background: #333;
            color: #fff;
            padding: 6px 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 999;
            max-width: 500px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        td.comment-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        td.comment-cell input {
            width: 100%;
            min-width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            padding: 2px 4px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .wrapper {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        .top-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .table-container {
            overflow-x: auto !important;
            width: 100%;
        }
        table {
            display: table;
            margin: 0 auto;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–∞–±–ª–∏—Ü—ã —Å CSS Grid */
        .table-container {
            position: relative;
        }
        
        .sticky-header, .sticky-input {
            display: grid;
            /* –ü–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫:
               1) ‚Ññ
               2) Sklad
               3) Invask
               4) Okno
               5) United
               6) –ú–æ–¥–µ–ª—å
               7) –°—Ç–∞—Ç—É—Å
               8) –ù–∞–ª
               9) –û–ø—Ç
               10) %
               11) –¶–µ–Ω–∞
               12) –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
               13) –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è
               14) –î–µ–π—Å—Ç–≤–∏—è
            */
            grid-template-columns:
                30px    /* ‚Ññ */
                80px    /* Sklad */
                75px    /* Invask */
                75px    /* Okno */
                85px    /* United */
                250px   /* –ú–æ–¥–µ–ª—å */
                70px    /* –°—Ç–∞—Ç—É—Å */
                60px    /* –ù–∞–ª */
                90px    /* –û–ø—Ç */
                70px    /* % */
                180px   /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
                80px    /* –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è */
                ;       /* –í–∞–∂–Ω–æ: –∫–æ–ª–æ–Ω–∫–∞ "–î–µ–π—Å—Ç–≤–∏—è" —Ä–∏—Å—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ–π .header-cell, —Å–º. –Ω–∏–∂–µ */
            position: sticky;
            z-index: 100;
            background: white;
            border: 1px solid #ccc;
        }

        /* üü£ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ grid-template-columns –¥–ª—è Wildberries */
        /* üü£ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ grid-template-columns –¥–ª—è Wildberries (–ù–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫ –∏ –∫–æ–ª-–≤–æ) */
        /* –í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –î–§: ‚Ññ + 14 –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ ¬´–î–µ–π—Å—Ç–≤–∏—è¬ª) */
        .header-wildberries.sticky-header,
        .header-wildberries.sticky-input {
            grid-template-columns:
                23px   /* ‚Ññ */
                70px   /* Sklad */
                105px  /* Invask */
                80px   /* Okno */
                75px   /* United */
                105px  /* WB Barcode */
                80px   /* WB –ê—Ä—Ç–∏–∫—É–ª */
                253px  /* –ú–æ–¥–µ–ª—å */
                50px   /* –°—Ç–∞—Ç—É—Å */
                30px   /* –ù–∞–ª */
                68px   /* –û–ø—Ç */
                58px   /* % */
                68px   /* –¶–µ–Ω–∞ */
                126px  /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
                111px  /* –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è */;
        }
        
        .sticky-header {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
        
        .sticky-header .header-cell:first-child {
            border-top-left-radius: 5px;
        }
        
        .sticky-header .header-cell:last-child {
            border-top-right-radius: 5px;
        }
        
        .sticky-header {
            top: 0;
        }
        
        .sticky-input {
            top: 31px;
            z-index: 99;
        }
        
        .header-cell, .input-cell {
            padding: 4px 6px;
            border-right: 1px solid #ccc;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 25px;
        }
        
        .header-cell:last-child, .input-cell:last-child {
            border-right: none;
        }
        
        .header-cell a {
            color: black;
            text-decoration: none;
            width: 100%;
        }
        
        .input-cell input, .input-cell select {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 4px;
            box-sizing: border-box;
        }
        
        /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã */
        .main-table {
            table-layout: fixed;
        }
        /* –£–ú–ï–ù–¨–®–ï–ù–ù–´–ï –ù–ê 10% –®–ò–†–ò–ù–´ (Yandex –∏ Ozon) */
        .main-table td:nth-child(1)  { width: 23px !important; }   /* ‚Ññ */
        .main-table td:nth-child(2)  { width: 35px !important; }   /* Sklad */
        .main-table td:nth-child(3)  { width: 35px !important; }   /* Invask */
        .main-table td:nth-child(4)  { width: 35px !important; }   /* Okno */
        .main-table td:nth-child(5)  { width: 35px !important; }   /* United */
        .main-table td:nth-child(6)  { width: 250px !important; }  /* –ú–æ–¥–µ–ª—å */
        .main-table td:nth-child(7)  { width: 30px !important; }   /* –°—Ç–∞—Ç—É—Å */
        .main-table td:nth-child(8)  { width: 20px !important; }   /* –ù–∞–ª */
        .main-table td:nth-child(9)  { width: 45px !important; }   /* –û–ø—Ç */
        .main-table td:nth-child(10) { width: 28px !important; }   /* % */
        .main-table td:nth-child(11) { width: 50px !important; }   /* –¶–µ–Ω–∞ */
        .main-table td:nth-child(12) { width: 162px !important; }  /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
        .main-table td:nth-child(13) { width: 75px !important; }   /* –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è */
        .main-table td:nth-child(14) { width: 48px !important; }   /* –î–µ–π—Å—Ç–≤–∏—è */

        /* üü£ –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã Wildberries (–Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫) */
        /* 1..16: ‚Ññ, Sklad, Invask, Okno, United, WB Barcode, WB –ê—Ä—Ç–∏–∫—É–ª,
                  –ú–æ–¥–µ–ª—å, –°—Ç–∞—Ç—É—Å, –ù–∞–ª, –û–ø—Ç, %, –¶–µ–Ω–∞, –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –î–µ–π—Å—Ç–≤–∏—è */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(1)  { width: 30px !important; }   /* ‚Ññ */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(2)  { width: 40px !important; }   /* Sklad */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(3)  { width: 40px !important; }  /* Invask */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(4)  { width: 40px !important; }   /* Okno */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(5)  { width: 40px !important; }   /* United */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(6)  { width: 90px !important; }  /* WB Barcode */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(7)  { width: 65px !important; }   /* WB –ê—Ä—Ç–∏–∫—É–ª */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(8)  { width: 253px !important; }  /* –ú–æ–¥–µ–ª—å */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(9)  { width: 40px !important; }   /* –°—Ç–∞—Ç—É—Å */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(10) { width: 30px !important; }   /* –ù–∞–ª */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(11) { width: 60px !important; }   /* –û–ø—Ç */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(12) { width: 30px !important; }   /* % */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(13) { width: 60px !important; }   /* –¶–µ–Ω–∞ */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(14) { width: 126px !important; }  /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(15) { width: 100px !important; }  /* –î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è */
        .header-wildberries ~ .table-wrapper .main-table td:nth-child(16) { width: 55px !important; }   /* –î–µ–π—Å—Ç–≤–∏—è */
        


        .letter-filter a {
            padding: 6px 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            text-decoration: none;
            color: #333;
            transition: all 0.2s ease;
        }

        .letter-filter a:hover {
            background-color: #f0f0f0;
        }

        .letter-filter a.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        /* –ï–¥–∏–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü: –∞–ª—Ñ–∞–≤–∏—Ç —Å–≤–µ—Ä—Ö—É, –ø–æ–∏—Å–∫ –Ω–∏–∂–µ, –æ–¥–Ω–∞ —à–∏—Ä–∏–Ω–∞ */
          .letters-and-search {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
          }
          .letters-and-search .letters {
            display: flex;
            flex-direction: column;
            gap: 6px;
          }
          .letters-and-search .letters .row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
          }
          .letters-and-search .search-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
          }
          .letters-and-search .search-row .search-wrap {
            position: relative;
            flex: 1 1 auto;   /* –∏–Ω–ø—É—Ç —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è –ø–æ —à–∏—Ä–∏–Ω–µ –∞–ª—Ñ–∞–≤–∏—Ç–∞ */
          }
          .letters-and-search input[type="search"] {
            width: 100%;
            height: 32px;
            font-size: 15px;
            padding: 6px 32px 6px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
          }
          .letters-and-search .search-row button[type="submit"]{
            height: 32px;
            padding: 0 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background:#f0f0f0;
            display:flex; align-items:center; gap:6px;
            font-size:15px; cursor:pointer;
          }
          /* –ù–∏–∂–Ω—è—è –ø–æ–ª–æ—Å–∞: log —Å–ª–µ–≤–∞, +/- —Å–ø—Ä–∞–≤–∞, –ø–æ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */
          .letters-and-search .controls-under {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
          }
          .letters-and-search .controls-under .left,
          .letters-and-search .controls-under .right {
            display: flex; align-items: center; gap: 10px;
          }
          .btn-markup {
            height: 28px;
            padding: 0 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background:#f8f8f8;
            cursor: pointer;
          }
        html, body {
            width: 100%;
            height: 100vh;
        }
        /* –î–û–ë–ê–í–¨ –≤ –∫–æ–Ω–µ—Ü —Ç–æ–≥–æ –∂–µ <style>, –≥–¥–µ —É–∂–µ –ª–µ–∂–∏—Ç –º–æ–±–∏–ª—å–Ω—ã–π –º–µ–¥–∏–∞–∑–∞–ø—Ä–æ—Å */
        /* --- –ú–æ–±–∏–ª—å–Ω—ã–π —Ñ–∏–∫—Å (‚â§ 767 px) ----------------------------------- */
        /* –ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ–¥–∏–∞–∑–∞–ø—Ä–æ—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        /*
        @media (max-width: 767px){
            html, body{
                 height: auto;
                 min-height: 100vh;
             }

          .table-container{
              justify-content: flex-start;
              overflow-x: auto;
              margin-left: -20px;
              margin-right: -20px;
              padding-left: 20px;
              padding-right: 20px;
          }

          .table-container > table{
              margin: 0;
          }
        }
        */
        thead {
            position: relative;
        }
        .table-wrapper {
          max-height: 80vh; /* –∏–ª–∏ –Ω—É–∂–Ω–∞—è —Ç–µ–±–µ –≤—ã—Å–æ—Ç–∞ */
          overflow-y: scroll; /* –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
          overflow-x: hidden; /* –æ—Ç–∫–ª—é—á–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
          scrollbar-gutter: stable; /* –≤—Å–µ–≥–¥–∞ —Ä–µ–∑–µ—Ä–≤–∏—Ä—É–µ–º –º–µ—Å—Ç–æ –ø–æ–¥ —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
        }

        table {
          border-collapse: collapse;
          width: 100%;
        }

        thead th {
          position: sticky;
          top: 0;
          background: #fff;
          z-index: 2;
        }
        thead tr:nth-child(1) th {
            position: sticky;
            top: 0;
            z-index: 3;
        }

        thead tr:nth-child(2) td {
            position: sticky;
            top: 35px; /* –∏–ª–∏ –ø–æ–¥—Å—Ç—Ä–æ–π –ø–æ–¥ —Å–≤–æ—é –≤—ã—Å–æ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            background: white;
            z-index: 2;
        }
        thead tr:nth-child(2) td {
            position: sticky;
            top: 35px;
            background: white;
            z-index: 2;
            height: 38px;
        }
        .sticky-input input,
        .sticky-input select,
        .sticky-input button {
            border-radius: 8px;
            padding: 3px 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            height: 30px;
            font-size: 14px;
        }
        .main-table td,
        .main-table th,
        .main-table input,
        .main-table select {
            font-size: 90% !important;
        }
        .error-indicator {
            color: red;
            font-size: 18px;
            font-weight: bold;
            margin-left: 2px;
            line-height: 1;
          }
        /* ‚Äî‚Äî‚Äî –ï–¥–∏–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ–¥ –≤—ã—Å–æ—Ç—É –∞–ª—Ñ–∞–≤–∏—Ç–∞ ‚Äî‚Äî‚Äî */
        :root{
          --ctl-h: 28px;          /* –≤—ã—Å–æ—Ç–∞, –∫–∞–∫ —É –±—É–∫–≤ */
          --ctl-radius: 6px;      /* —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
          --ctl-font: 14px;       /* —à—Ä–∏—Ñ—Ç */
          --ctl-pad-x: 10px;      /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
        }

        /* –ê–ª—Ñ–∞–≤–∏—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .letter-filter a{
          height: var(--ctl-h);
          padding: 0 var(--ctl-pad-x);
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border-radius: var(--ctl-radius);
          font-size: var(--ctl-font);
        }

        /* –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ */
        #custom-search{
          height: var(--ctl-h);
          padding: 0 28px 0 var(--ctl-pad-x); /* –º–µ—Å—Ç–æ –ø–æ–¥ –∫—Ä–µ—Å—Ç–∏–∫ —Å–ø—Ä–∞–≤–∞ */
          font-size: var(--ctl-font);
          border-radius: var(--ctl-radius);
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ù–∞–π—Ç–∏" */
        form[action^="/table/"] button[type="submit"]{
          height: var(--ctl-h) !important;
          padding: 0 var(--ctl-pad-x) !important;
          border-radius: var(--ctl-radius) !important;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          font-size: var(--ctl-font);
        }

        /* –ö–Ω–æ–ø–∫–∏ –Ω–∞—Ü–µ–Ω–∫–∏ */
        #btn-markdown-dec,
        #btn-markdown-inc{
          height: var(--ctl-h);
          padding: 0 8px;
          border-radius: var(--ctl-radius);
          display: inline-flex;
          align-items: center;
          justify-content: center;
          font-size: var(--ctl-font);
        }
        /* === –ï–¥–∏–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∏ —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è === */
        :root {
          --ctl-h: 32px;       /* –µ–¥–∏–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
          --ctl-radius: 6px;   /* —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
          --ctl-font: 14px;    /* —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
          --ctl-pad-x: 10px;   /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
        }

        /* –ê–ª—Ñ–∞–≤–∏—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .letter-filter a {
          height: var(--ctl-h) !important;
          padding: 0 var(--ctl-pad-x) !important;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border-radius: var(--ctl-radius);
          font-size: var(--ctl-font);
        }

        /* –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ */
        #custom-search {
          height: var(--ctl-h) !important;
          padding: 0 28px 0 var(--ctl-pad-x) !important;
          font-size: var(--ctl-font);
          border-radius: var(--ctl-radius);
          box-sizing: border-box;
        }

        /* –ö–Ω–æ–ø–∫–∞ "–ù–∞–π—Ç–∏" */
        form[action^="/table/"] button[type="submit"] {
          height: var(--ctl-h) !important;
          padding: 0 var(--ctl-pad-x) !important;
          border-radius: var(--ctl-radius) !important;
          display: inline-flex;
          align-items: center;
          gap: 6px;
          font-size: var(--ctl-font);
        }

        /* –ö–Ω–æ–ø–∫–∏ ¬±1% */
        #btn-markdown-dec,
        #btn-markdown-inc {
          height: var(--ctl-h) !important;
          padding: 0 var(--ctl-pad-x) !important;
          border-radius: var(--ctl-radius);
          display: inline-flex;
          align-items: center;
          justify-content: center;
          font-size: var(--ctl-font);
        }

        /* –í—Å–µ –∫–Ω–æ–ø–∫–∏ –∏ –ø–æ–ª—è –≤ –æ–¥–Ω–æ–π –ª–∏–Ω–∏–∏ */
        form, .letter-filter, #btn-markdown-dec, #btn-markdown-inc {
          vertical-align: middle;
        }
        :root{
          --stack-gap: 8px; /* –µ–¥–∏–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä –º–µ–∂–¥—É —Ä—è–¥–∞–º–∏ */
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –±–ª–æ–∫–∞ –ø–æ–∏—Å–∫–∞ */
        .letter-filter a.active {
            background-color: #007bff !important;
            color: white !important;
            border-color: #007bff !important;
        }
        
        .letter-filter a:hover {
            background-color: #f0f0f0 !important;
        }
        /* === –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º (—É–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã, –≤—ã—Å–æ—Ç–∞, –æ—Ç—Å—Ç—É–ø—ã) === */
        body.compact .main-table td,
        body.compact .main-table th,
        body.compact .main-table input,
        body.compact .main-table select {
          font-size: 14px !important;   /* –±—ã–ª–æ ~14px/90% */
          line-height: 1.1;
        }

        body.compact td,
        body.compact th {
          height: 5px;        /* ‚Üì –≤–º–µ—Å—Ç–æ 22px */
          max-height: 5px;    /* ‚Üì –≤–º–µ—Å—Ç–æ 24px */
          padding: 1px 3px;    /* ‚Üì –≤–º–µ—Å—Ç–æ 2px 4px */
        }

        body.compact .header-cell,
        body.compact .input-cell {
          min-height: 22px;              /* –±—ã–ª–æ ~25px */
          padding: 2px 4px;              /* –±—ã–ª–æ 4px 6px */
        }

        body.compact .sticky-input input,
        body.compact .sticky-input select,
        body.compact .sticky-input button {
          height: 24px;                  /* –±—ã–ª–æ ~30px */
          font-size: 12px;
          padding: 2px 6px;
          border-radius: 4px;
        }

        /* –ß—É—Ç—å –ø–ª–æ—Ç–Ω–µ–µ ¬´–¥–≤—É—Ö—ç—Ç–∞–∂–Ω–∞—è¬ª —à–∞–ø–∫–∞ (—Ö–µ–¥–µ—Ä + —Ñ–∏–ª—å—Ç—Ä—ã) */
        body.compact .sticky-input { top: 26px; }  /* –±—ã–ª–æ 31px */
        /* –ú—è–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ */
        .supplier-active {
          background: #eaf6ff !important;   /* –Ω–µ–∂–Ω–æ-–≥–æ–ª—É–±–æ–π */
        }
        .supplier-active input {
          background: #eaf6ff !important;
        }
         /* –ü–æ–ª–Ω–æ–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö */
        .main-table tbody tr,
        .main-table tbody td {
          height: 0 !important;          /* —É–±–∏—Ä–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã */
          min-height: 0 !important;
          max-height: none !important;
          padding: 0 !important;
          margin: 0 !important;
          line-height: 1 !important;     /* —Ç–µ–∫—Å—Ç –ø–ª–æ—Ç–Ω—ã–π */
          border-collapse: collapse;
          vertical-align: middle !important;
          font-size: 10px !important;
        }

        /* –ò–Ω–ø—É—Ç—ã –∏ —Å–µ–ª–µ–∫—Ç—ã —Ç–æ–∂–µ –∂–º—ë–º */
        .main-table tbody td input,
        .main-table tbody td select {
          font-size: 10px !important;
          height: 100% !important;
          line-height: 1 !important;
          padding: 0 !important;
          margin: 0 !important;
          box-sizing: border-box;
        }
        /* üî• –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ —Å—Ç—Ä–æ–∫ (–∫—Ä–æ–º–µ —à–∞–ø–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏ –≤–≤–æ–¥–∞) */
        .main-table tbody tr td {
          font-size: 11px !important;
          line-height: 1 !important;
          height: 23px !important;           /* —è—á–µ–π–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∏–∑–∫–∏–º–∏ */
          padding: 0 2px !important;
          margin: 0 !important;
          border-collapse: collapse !important;
          vertical-align: middle !important;
          white-space: nowrap;
        }

        /* –ò–Ω–ø—É—Ç—ã –∏ —Å–µ–ª–µ–∫—Ç—ã –≤–Ω—É—Ç—Ä–∏ —è—á–µ–µ–∫ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ */
        .main-table tbody td input,
        .main-table tbody td select {
          font-size: 12px !important;
          height: 22px !important;           /* –ø–æ–ª–µ –≤—ã—à–µ —Å–∞–º–æ–π —è—á–µ–π–∫–∏ */
          line-height: 1.2 !important;
          padding: 2px 6px !important;
          margin: 0 !important;
          box-sizing: border-box !important;
        }
        /* üîΩ –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —á—É—Ç—å –º–µ–Ω—å—à–µ —à—Ä–∏—Ñ—Ç–æ–º */
        .main-table th,
        .sticky-header .header-cell {
            font-size: 88% !important;   /* –±—ã–ª–æ 90% */
            font-weight: bold;           /* –¥–µ–ª–∞–µ–º –∂–∏—Ä–Ω—ã–º */
        }
        /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏ –≤ —Å—Ç–æ–ª–±—Ü–µ –î–µ–π—Å—Ç–≤–∏—è */
        .action-cell button img {
            display: inline-block;
            vertical-align: middle; /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å—Ç—Ä–æ–∫–∏ */
            margin-top: -2px;       /* –µ—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ –≤—Å–µ —Ä–∞–≤–Ω–æ –≤—ã—à–µ ‚Äî –ø–æ–¥–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é */
        }
        /* üîπ –ú—è–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π */
        input[required],
        select[required] {
            border: 1px solid #ffb347 !important;  /* —Ç–æ–Ω–∫–∞—è –æ—Ä–∞–Ω–∂–µ–≤–∞—è —Ä–∞–º–∫–∞ */
            background-color: #fff8f0;             /* —á—É—Ç—å —Ç–µ–ø–ª—ã–π —Ñ–æ–Ω */
        }

        /* –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ ‚Äî —á—É—Ç—å —è—Ä—á–µ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª */
        input[required]:focus,
        select[required]:focus {
            border-color: #ff8000 !important;
            background-color: #fff4e6;
            outline: none;
        }
        /* üîπ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –ø–æ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—É */
        {% if selected_table == 'yandex' %}
          input[required],
          select[required] {
            border: 1px solid #FFD633 !important;
            background-color: #FFFBEA;
          }
          input[required]:focus,
          select[required]:focus {
            border-color: #E6B800 !important;
            background-color: #FFF5CC;
          }
        {% elif selected_table == 'ozon' %}
          input[required],
          select[required] {
            border: 1px solid #005BFF !important;
            background-color: #F0F6FF;
          }
          input[required]:focus,
          select[required]:focus {
            border-color: #0041B3 !important;
            background-color: #E0EDFF;
          }
        {% elif selected_table == 'wildberries' %}
          input[required],
          select[required] {
            border: 1px solid #9B30FF !important;
            background-color: #FAF0FF;
          }
          input[required]:focus,
          select[required]:focus {
            border-color: #6A00CC !important;
            background-color: #F0E0FF;
          }
        {% endif %}
        .price-cell {
          display: inline-flex;
          justify-content: flex-end;
          min-width: 70px; /* –ø–æ–¥—Å—Ç—Ä–æ–π —à–∏—Ä–∏–Ω—É –ø–æ–¥ —Å–≤–æ–∏ —á–∏—Å–ª–∞ */
        }
        .price-value {
          text-align: right;
          min-width: 55px;
          font-variant-numeric: tabular-nums;
        }
        .price-symbol {
          margin-left: 2px;
        }
        .copy-tooltip {
          position: fixed;
          background: #333;
          color: #fff;
          font-size: 12px;
          padding: 2px 6px;
          border-radius: 4px;
          pointer-events: none;
          opacity: 0;
          transition: opacity 0.2s ease;
          z-index: 9999;
        }
        /* === FULLSCREEN OVERLAY –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π === */
        #screen-overlay[hidden] { display: none !important; }

        #screen-overlay {
          position: fixed;
          inset: 0;
          z-index: 99999;
          background: rgba(0,0,0,0.45);
          display: flex;
          align-items: center;
          justify-content: center;
          backdrop-filter: blur(1px);
        }

        .overlay-box {
          min-width: 360px;
          max-width: 90vw;
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.25);
          padding: 18px 20px;
          text-align: center;
          font-family: 'Inter', sans-serif;
        }

        .overlay-title {
          font-size: 16px;
          font-weight: 600;
          margin: 0 0 8px 0;
          color: #333;
        }

        .overlay-note {
          font-size: 13px;
          color: #666;
          margin-bottom: 14px;
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–∏–Ω–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) */
        .progress {
          position: relative;
          width: 100%;
          height: 8px;
          background: #eee;
          border-radius: 6px;
          overflow: hidden;
        }
        .progress-bar {
          position: absolute;
          left: -40%;
          top: 0;
          height: 100%;
          width: 40%;
          background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
          border-radius: 6px;
          animation: indeterminate 1.2s infinite;
        }
        @keyframes indeterminate {
          0%   { left: -40%; width: 40%; }
          50%  { left: 20%;  width: 60%; }
          100% { left: 100%; width: 40%; }
        }


    </style>
</head>
<body class="compact">
<div id="copy-tooltip" class="copy-tooltip"></div>
<div class="wrapper">
    <div class="top-panel" style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%; flex-wrap: nowrap; gap: 12px; margin-bottom: 0px;">
      <div style="display: flex; align-items: flex-start; gap: 12px;">
          <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ –∏ –±–ª–æ–∫ –ø–æ–∏—Å–∫–∞ -->
          <div style="display: flex; flex-direction: column; gap: 12px; align-items: flex-start;">
            <!-- –ü–µ—Ä–≤—ã–π –±–ª–æ–∫: Sklad –æ–±–Ω–æ–≤–ª–µ–Ω –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div id="first-block-row" style="display: flex; gap: 30px; align-items: flex-start;">
                {% if last_download_time %}
                <div style="font-size: 15px; color: #555; display: flex; flex-direction: column; gap: 6px; min-width: 200px;">
                  <div style="font-weight: normal;">Sklad –æ–±–Ω–æ–≤–ª–µ–Ω:</div>
                  <div>{{ last_download_time }}</div>
                  <div style="font-size: 15px; color: #007bff; cursor: pointer;" id="manual-update-btn">
                    –û–±–Ω–æ–≤–∏—Ç—å
                  </div>
                </div>
                {% endif %}
        
                {% if stats %}
                <div style="font-size: 15px; color: #555; display: flex; flex-direction: column; gap: 6px; min-width: 160px; transform: translateX(60px);">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span>–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:</span>
                    <span>{{ stats['–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤'] }}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span>–í –Ω–∞–ª–∏—á–∏–∏:</span>
                    <span>{{ stats['–í –Ω–∞–ª–∏—á–∏–∏'] }}</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span>–û—Ç–∫–ª—é—á–µ–Ω–æ:</span>
                    <span>{{ stats['–û—Ç–∫–ª—é—á–µ–Ω–æ'] }}</span>
                  </div>
                </div>
                {% endif %}

                <!-- –ì—Ä—É–ø–ø–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π (—Ä—è–¥–æ–º —Å –ø–µ—Ä–≤—ã–º –±–ª–æ–∫–æ–º) -->
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div class="nav" style="transform: translateX(150px);">
                      <a href="/table/yandex?search={{ request.args.get('search', '') }}&letter={{ request.args.get('letter', '') }}"
                         class="{% if selected_table == 'yandex' %}active yandex{% endif %}">Yandex</a>
                      <a href="/table/ozon?search={{ request.args.get('search', '') }}&letter={{ request.args.get('letter', '') }}"
                         class="{% if selected_table == 'ozon' %}active ozon{% endif %}">Ozon</a>
                      <a href="/table/wildberries?search={{ request.args.get('search', '') }}&letter={{ request.args.get('letter', '') }}"
                         class="{% if selected_table == 'wildberries' %}active wildberries{% endif %}">Wildberries</a>
                  </div>
                  <div style="font-size: 15px; color: #555; display: flex; flex-direction: column; gap: 6px; min-width: 120px; margin-left: 250px;">
                      {% for mp in ['yandex', 'ozon', 'wildberries'] %}
                      <label style="display: flex; align-items: center; justify-content: space-between;">
                        <span style="min-width: 90px;">{{ mp.capitalize() }}</span>
                        <label class="toggle-switch">
                          <input type="checkbox" data-market="{{ mp }}" class="global-toggle" {% if global_stock_flags[mp] %}checked{% endif %}>
                          <span class="toggle-slider"></span>
                        </label>
                      </label>
                      {% endfor %}
                  </div>
                </div>
            </div>
            <!-- / –ü–µ—Ä–≤—ã–π –±–ª–æ–∫ -->
    
            <!-- –í—Ç–æ—Ä–æ–π –±–ª–æ–∫: –∫–æ–º–ø–æ–Ω–æ–≤–∫–∞ –ø–æ –º–∞–∫–µ—Ç—É (–ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –∫–Ω–æ–ø–∫–∏; —Ü–µ–Ω—Ç—Ä ‚Äî –∞–ª—Ñ–∞–≤–∏—Ç; —Å–ø—Ä–∞–≤–∞ ‚Äî –ø–æ–∏—Å–∫, log, –Ω–∞—Ü–µ–Ω–∫–∞) -->
            <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 12px; margin-top: 5px; margin-bottom: 12px; width: 100%;">
              <!-- –ö–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" –∏ "–ù–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã" –¥—Ä—É–≥ –Ω–∞–¥ –¥—Ä—É–≥–æ–º -->
                <div style="display: flex; flex-direction: column; gap: 10px; margin-right: 15px;">
                  <a href="/statistic"
                       style="display: flex; align-items: center; gap: 6px;
                              padding: 6px 12px; font-size: 15px;
                              border-radius: 6px; border: 1px solid #ccc;
                              background-color: #f0f0f0;
                              color: #333; text-decoration: none;
                              transition: all 0.2s;">
                      <img src="{{ url_for('static', filename='icons/stats.svg') }}" alt="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" width="16" height="16">
                      –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                      {% if has_errors %}
                        <span class="error-indicator">üü†</span>
                      {% endif %}
                    </a>

                  <a href="/download_unlisted"
                     style="display: flex; align-items: center; gap: 6px;
                            padding: 6px 12px; font-size: 15px;
                            border-radius: 6px; border: 1px solid #ccc;
                            background-color: #f0f0f0;
                            color: #333; text-decoration: none;
                            transition: all 0.2s;">
                    <img src="{{ url_for('static', filename='icons/file-upload.svg') }}" alt="–ó–∞–≥—Ä—É–∑–∫–∞" width="16" height="16">
                    –ù–æ–≤—ã–µ —Ç–æ–≤–∞—Ä—ã
                  </a>
                </div>

              <!-- –ê–ª—Ñ–∞–≤–∏—Ç -->
                <div class="letter-filter" style="display:flex; flex-direction:column; gap: var(--stack-gap);">
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  {% set row1 = ['0-9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M'] %}
                  {% for letter in row1 %}
                    <a href="{{ url_for('show_table', table_name=selected_table, letter=letter, search=request.args.get('search', '')) }}"
                       class="{% if request.args.get('letter') == letter %}active{% endif %}">
                      {{ letter }}
                    </a>
                  {% endfor %}
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                  {% set row2 = ['N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '–ê-–Ø'] %}
                  {% for letter in row2 %}
                    <a href="{{ url_for('show_table', table_name=selected_table, letter=letter, search=request.args.get('search', '')) }}"
                       class="{% if request.args.get('letter') == letter %}active{% endif %}">
                      {{ letter }}
                    </a>
                  {% endfor %}
                </div>
              </div>

              <!-- –ü–æ–∏—Å–∫–æ–≤–∞—è —Ñ–æ—Ä–º–∞ -->
              <div style="display:flex; flex-direction:column; gap: var(--stack-gap); margin-left: 10px;">
                  <form method="GET" action="/table/{{ selected_table }}"
                        style="display: flex; align-items: center; gap: 10px;">
                    <div style="position: relative;">
                      <input type="search" id="custom-search" name="search"
                       placeholder="–ü–æ–∏—Å–∫:"
                       value="{{ request.args.get('search', '') }}"
                       style="font-size: 15px; padding: 6px 12px; border-radius: 6px;
                              width: 300px; box-sizing: border-box; border: 1px solid #ccc;">
                                    </div>

                    <button type="submit"
                            style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 15px;
                                   border-radius: 6px; border: 1px solid #ccc; background-color: #f0f0f0;
                                   cursor: pointer; transition: all 0.2s;">
                      <img src="{{ url_for('static', filename='icons/search.svg') }}" alt="üîç" width="16" height="16">
                      –ù–∞–π—Ç–∏
                    </button>
                  </form>
                  <div style="font-size: 13px; color: #777; display: flex; align-items: center; gap: 10px;">
                      <a href="/download_log"
                           style="text-decoration: none; color: #777;
                                  display: inline-flex; align-items: center; justify-content: center;
                                  height: var(--ctl-h); padding: 0 var(--ctl-pad-x);
                                  border: 1px solid #ccc; border-radius: var(--ctl-radius);
                                  font-size: var(--ctl-font); background: #f8f8f8; cursor: pointer;"
                           download>log</a>

                      <!-- –ì—Ä—É–ø–ø–æ–≤–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –Ω–∞—Ü–µ–Ω–∫–∏ -->
                      <div style="display:flex; align-items:center; gap:6px; margin-left: 73px;">
                        <span style="font-size:14px; color:#555;">–ù–∞—Ü–µ–Ω–∫–∞:</span>
                        <button type="button" id="btn-markdown-dec"
                                style="padding:2px 8px; border:1px solid #ccc; border-radius:6px; background:#f8f8f8; cursor:pointer;">
                          ‚àí1%
                        </button>
                        <button type="button" id="btn-markdown-inc"
                                style="padding:2px 8px; border:1px solid #ccc; border-radius:6px; background:#f8f8f8; cursor:pointer;">
                          +1%
                        </button>
                      </div>
                    </div>

                    <script>
                    (function(){
                      const selected = "{{ selected_table }}";
                      function adjust(delta){
                        document.getElementById('btn-markdown-dec')?.setAttribute('disabled', 'disabled');
                        document.getElementById('btn-markdown-inc')?.setAttribute('disabled', 'disabled');

                        fetch(`/bulk_markup/${selected}`, {
                          method: 'POST',
                          headers: {'Content-Type':'application/x-www-form-urlencoded'},
                          body: `delta=${delta}`
                        }).then(r => {
                          if (r.ok){
                            Swal.fire({
                              toast:true, position:'top-end', icon:'success',
                              title: (delta>0?'+1%':'-1%')+' –ø—Ä–∏–º–µ–Ω–µ–Ω–æ',
                              showConfirmButton:false, timer:1500
                            });
                            location.reload();
                          } else {
                            Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ü–µ–Ω–∫—É', 'error');
                          }
                        }).catch(() => {
                          Swal.fire('–û—à–∏–±–∫–∞', '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞', 'error');
                        }).finally(()=>{
                          document.getElementById('btn-markdown-dec')?.removeAttribute('disabled');
                          document.getElementById('btn-markdown-inc')?.removeAttribute('disabled');
                        });
                      }
                      document.getElementById('btn-markdown-dec')?.addEventListener('click', ()=>adjust(-1));
                      document.getElementById('btn-markdown-inc')?.addEventListener('click', ()=>adjust(1));
                    })();
                    </script>

                </div>
            </div>
            <!-- / –í—Ç–æ—Ä–æ–π –±–ª–æ–∫ -->
          </div>
          
          <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∏ –ú–ü, –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ -->
          <!-- –£–¥–∞–ª–µ–Ω–∞: –∫–Ω–æ–ø–∫–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã —Ä—è–¥–æ–º —Å –ª–µ–≤—ã–º –±–ª–æ–∫–æ–º -->
          <div style="display:none"></div>
      </div>
      <!-- –¢—Ä–µ—Ç–∏–π –±–ª–æ–∫: –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏ (–ø—Ä–∏–∂–∞—Ç –≤–ø—Ä–∞–≤–æ) -->
      <div style="font-size: 15px; color: #555; display: flex; flex-direction: column; gap: 6px; min-width: 120px; margin-left: auto; transform: translateX(-10px);">
        {% for supplier in suppliers_list %}
            {% set c = supplier_counts.get(supplier, {}) %}
            {% set ym = c.get('yandex', {}) %}
            {% set oz = c.get('ozon', {}) %}
            {% set wb = c.get('wildberries', {}) %}

            <label style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <span style="display:flex; flex-direction:column; min-width: 220px;">
                <span>{{ supplier }}</span>
                <span class="text-muted" style="font-size:12px; line-height:1.2;">
                  YM: {{ ym.get('total', 0) }} (–∞–∫—Ç: {{ ym.get('active', 0) }}) ¬∑
                  OZ: {{ oz.get('total', 0) }} (–∞–∫—Ç: {{ oz.get('active', 0) }}) ¬∑
                  WB: {{ wb.get('total', 0) }} (–∞–∫—Ç: {{ wb.get('active', 0) }})
                </span>
              </span>

              <label class="toggle-switch">
                <input type="checkbox"
                       class="supplier-toggle"
                       data-supplier="{{ supplier }}"
                       {% if global_stock_flags['suppliers'].get(supplier, True) %}checked{% endif %}>
                <span class="toggle-slider"></span>
              </label>
            </label>
          {% endfor %}
      </div>
    </div>
  
        {% if table_data is not none %}
            <div class="table-container">
              <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ -->
              <div class="sticky-header header-{{ selected_table }}">
                {% for col in table_data.columns %}
                  <div class="header-cell {% if col.strip() == '–ú–æ–¥–µ–ª—å' %}text-left{% else %}text-center{% endif %}">
                    <a href="{{ url_for(
                        'show_table',
                        table_name=selected_table,
                        search=request.args.get('search', ''),
                        letter=request.args.get('letter', ''),
                        sort=col,
                        order=(
                            'asc' if sort_column == col and sort_order == 'desc'
                            else 'desc' if sort_column == col
                            else ('desc' if col == '–ù–∞–ª' else 'asc')
                        )
                    ) }}">
                      {{ '–ò–∑–º–µ–Ω–µ–Ω–æ' if col == '–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è' else col }}
                    </a>
                  </div>
                {% endfor %}
                <div class="header-cell text-center">–î–µ–π—Å—Ç–≤–∏—è</div>
              </div>


              <script>
                window.addEventListener('DOMContentLoaded', function () {
                    const saved = sessionStorage.getItem('add_form_data');
                    if (saved) {
                        const values = JSON.parse(saved);
                        Object.keys(values).forEach(name => {
                            const input = document.querySelector(`[name="${name}"]`);
                            if (input) input.value = values[name];
                        });
                    }
                });
              </script>

              <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –≤–≤–æ–¥–∞ -->
              <div class="sticky-input header-{{ selected_table }}">
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const saved = sessionStorage.getItem('add_form_data');
                        if (saved) {
                            const values = JSON.parse(saved);
                            Object.keys(values).forEach(name => {
                                const input = document.querySelector(`[name="${name}"]`);
                                if (input) input.value = values[name];
                            });
                        }
                    });
                </script>

                <form method="POST" action="/add/{{ selected_table }}" style="display: contents;">
                    <script>
                      (function () {
                        // –ù–∞—Ö–æ–¥–∏–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è, —ç—Ç–æ —Ç–∞, —É –∫–æ—Ç–æ—Ä–æ–π action –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /add/
                        const addForm = document.querySelector('form[action^="/add/"]');
                        if (!addForm) return;

                        addForm.addEventListener('submit', function (e) {
                          try {
                            const formData = new FormData(addForm);

                            // –ë–∞–∑–æ–≤—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π —Å–ø–∏—Å–æ–∫ –ø–æ–¥ —Å–≤–æ—é –ª–æ–≥–∏–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
                            const requiredFields = ['Sklad', '–ú–æ–¥–µ–ª—å', '–ù–∞–ª', '–û–ø—Ç', '%'];

                            // –ì—Ä—É–ø–ø–∞ –ø–æ–ª–µ–π –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ ‚Äî —Ç—Ä–µ–±—É–µ–º, —á—Ç–æ–±—ã –±—ã–ª–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑ –Ω–∏—Ö


                            let missing = [];

                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö
                            requiredFields.forEach(field => {
                              const val = (formData.get(field) || '').trim();
                              if (!val) missing.push(field);
                            });

                            // –ü—Ä–æ–≤–µ—Ä–∫–∞ ¬´—Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ—Å—Ç–∞–≤—â–∏–∫¬ª
                            const hasAnySupplier = supplierFields.some(f => ((formData.get(f) || '').trim().length > 0));
                            if (!hasAnySupplier) {
                              missing.push('Invask/Okno/United (–º–∏–Ω–∏–º—É–º –æ–¥–Ω–æ –ø–æ–ª–µ)');
                            }

                            if (missing.length > 0) {
                              e.preventDefault();
                              alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n‚Ä¢ ' + missing.join('\n‚Ä¢ '));
                              return false;
                            }

                            // –ï—Å–ª–∏ –∞—Ä—Ç–∏–∫—É–ª—ã —É –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —á–∏—Å–ª–æ–≤—ã–µ ‚Äî —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –±–ª–æ–∫ –Ω–∏–∂–µ
                            /*
                            supplierFields.forEach(f => {
                              const v = (formData.get(f) || '').trim();
                              if (v && !/^\d+$/.test(v)) {
                                e.preventDefault();
                                alert('–ü–æ–ª–µ ' + f + ' –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.');
                                throw new Error('Validation failed: ' + f);
                              }
                            });
                            */
                          } catch (err) {
                            // –ú—è–≥–∫–æ –≥–∞—Å–∏–º –ª—é–±—ã–µ JS-–æ—à–∏–±–∫–∏, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                            console.warn('[validate add form]', err);
                          }
                        });
                      })();
                    </script>

                  {% for col in table_data.columns %}
                      <div class="input-cell {% if col.strip() == '–ú–æ–¥–µ–ª—å' %}text-left{% else %}text-center{% endif %}">
                        {% if col.strip() not in ['‚Ññ', '–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è', '–¶–µ–Ω–∞'] %}
                          {% if col.strip() == '–ù–∞–ª' %}
                            <!-- –ü–æ–ª–µ "–ù–∞–ª" —Å–∫—Ä—ã—Ç–æ, –≤—Å–µ–≥–¥–∞ = 0 -->
                            <input type="hidden" name="–ù–∞–ª" value="0">
                          {% elif col.strip() == '–°—Ç–∞—Ç—É—Å' %}
                            <select name="–°—Ç–∞—Ç—É—Å">
                              <option value=""></option>
                              <option value="–≤—ã–∫–ª.">–≤—ã–∫–ª.</option>
                            </select>
                          {% else %}
                            <input
                                type="text"
                                name="{{ col }}"
                                value="{{ saved_form_data.get(col, '') }}"
                                {% if col in ['–û–ø—Ç', '%', 'Sklad', 'WB Barcode', 'WB –ê—Ä—Ç–∏–∫—É–ª'] %}
                                  inputmode="numeric" pattern="\d*" maxlength="20"
                                  oninput="this.value = this.value.replace(/\D/g, '')"
                                {% endif %}
                                {% if col in ['Sklad', '–ú–æ–¥–µ–ª—å', '–û–ø—Ç', '%', 'WB Barcode', 'WB –ê—Ä—Ç–∏–∫—É–ª'] %}
                                  required
                                {% endif %}
                            >
                          {% endif %}
                        {% endif %}
                      </div>
                    {% endfor %}

                  <div class="input-cell text-center">
                    <button type="submit"
                            class="add-button add-button-{{ selected_table }}"
                            {% if editing_row_id %}disabled{% endif %}>
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                  </div>
                </form>
              </div>
              
              <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
              <div class="table-wrapper" style="height: calc(100vh - 300px); overflow-y: auto; overflow-x: hidden;">
                <table class="main-table" style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                  <tbody>

                  {% for row in table_data.values.tolist() %}
                  <tr data-active-supplier="{{ active_suppliers[loop.index0] if active_suppliers else '' }}">
                      {% for col, item in zip(table_data.columns, row) %}
                        {% set value = item if item is not none else '' %}
                        <td class="{% if col.strip() == '–ú–æ–¥–µ–ª—å' %}text-left{% elif col.strip() == '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' %}comment-cell{% else %}text-center{% endif %}{% if col.strip() in ['Invask', 'Okno', 'United'] %} text-muted{% endif %}"
                            {% if col.strip() in ['–ú–æ–¥–µ–ª—å', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'] and value|length > 35 %}title="{{ value }}"{% endif %}>
                          {% if col.strip() in ['–û–ø—Ç', '–¶–µ–Ω–∞'] %}
                          {% if value is number %}
                            <span class="price-cell">
                              <span class="price-value">{{ '{:,.0f}'.format(value).replace(',', ' ') }}</span>
                              <span class="price-symbol">—Ä.</span>
                            </span>
                          {% else %}
                            {{ value }}
                          {% endif %}
                        {% elif col.strip() == '%' %}
                          {{ value }} %
                        {% else %}
                          {{ value }}
                        {% endif %}
                        </td>
                      {% endfor %}
                      <td class="text-center action-cell">
                        <button type="button" class="edit-btn" style="border:none; background:none; cursor:pointer;">
                          <img src="{{ url_for('static', filename='icons/file-edit.svg') }}" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" width="18">
                        </button>
                        <form method="post" action="/delete/{{ selected_table }}/{{ row[table_data.columns.get_loc('Sklad')] }}" class="delete-form" style="display:inline;">
                          <input type="hidden" name="item_name" value="{{ row[table_data.columns.get_loc('–ú–æ–¥–µ–ª—å')] }}">
                          <button type="button" class="delete-btn" style="border:none; background:none; cursor:pointer;">
                            <img src="{{ url_for('static', filename='icons/trash.svg') }}" alt="–£–¥–∞–ª–∏—Ç—å" width="18">
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                  </tbody>
                </table>
                  <script>
                    (function() {
                      // 1) –°–ø–∏—Å–æ–∫ –∏–º—ë–Ω –∫–æ–ª–æ–Ω–æ–∫ –∏–∑ DataFrame ‚Üí —É–∑–Ω–∞—ë–º –∏–Ω–¥–µ–∫—Å—ã –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º
                      const headers = {{ table_data.columns.tolist() | tojson }};
                      const idx = {};
                      headers.forEach((h, i) => idx[h] = i);

                      // 2) –¢–æ–ª—å–∫–æ —ç—Ç–∏ —á–µ—Ç—ã—Ä–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
                      const supplierCols = ['Sklad', 'Invask', 'Okno', 'United'];

                      // 3) –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥—Å–≤–µ—Ç–∏–º —è—á–µ–π–∫—É –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
                      document.querySelectorAll('.main-table tbody tr').forEach(tr => {
                        const sup = (tr.getAttribute('data-active-supplier') || '').trim();
                        if (!supplierCols.includes(sup)) return;

                        const colIdx = idx[sup];
                        if (typeof colIdx !== 'number') return;

                        const td = tr.children[colIdx];
                        if (!td) return;

                        td.classList.add('supplier-active'); // –º—è–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
                        if (!td.title) td.title = `–ê–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ—Å—Ç–∞–≤—â–∏–∫: ${sup}`; // –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
                      });
                    })();
                    </script>
              </div>
            </div>
            
        {% endif %}
</div>
    <!-- === FULLSCREEN OVERLAY === -->
    <div id="screen-overlay" hidden>
      <div class="overlay-box" role="alert" aria-live="assertive" aria-busy="true">
        <div class="overlay-title" id="overlay-title">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–ø–µ—Ä–∞—Ü–∏—è‚Ä¶</div>
        <div class="overlay-note" id="overlay-note">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</div>
        <div class="progress" aria-hidden="true">
          <div class="progress-bar"></div>
        </div>
      </div>
    </div>
    <script src="{{ url_for('static', filename='js/sweetalert2.all.min.js') }}"></script>
    <script>
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ Grid —Å —Ä–µ–∞–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
    function syncColumnWidths() {
        const mainTable = document.querySelector('.main-table');
        const stickyHeader = document.querySelector('.sticky-header');
        const stickyInput = document.querySelector('.sticky-input');
        const tableWrapper = document.querySelector('.table-wrapper');
        
        if (!mainTable || !stickyHeader || !stickyInput || !tableWrapper) return;
        
        const selectedTable = "{{ selected_table }}";
        const storageKey = `tableColumnWidths_${selectedTable}`;
        
        // –ñ–¥–µ–º –∫–æ–≥–¥–∞ —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è
        setTimeout(() => {
            const firstRow = mainTable.querySelector('tbody tr');
            
            if (firstRow) {
                // –ï—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ - –∏–∑–º–µ—Ä—è–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
                const cells = firstRow.querySelectorAll('td');
                const headerCells = stickyHeader.children;
                const inputCells = stickyInput.children;
                
                let totalWidth = 0;
                const widths = [];
                
                // –ò–∑–º–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ —à–∏—Ä–∏–Ω—ã —è—á–µ–µ–∫ —Ç–∞–±–ª–∏—Ü—ã
                for (let i = 0; i < cells.length; i++) {
                    const width = cells[i].offsetWidth;
                    widths.push(width + 'px');
                    totalWidth += width;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–µ–Ω –ª–∏ —Å–∫—Ä–æ–ª–ª–±–∞—Ä
                const hasScrollbar = tableWrapper.scrollHeight > tableWrapper.clientHeight;
                const scrollbarWidth = hasScrollbar ? (tableWrapper.offsetWidth - tableWrapper.clientWidth) : 0;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ localStorage
                const widthsData = {
                    widths: widths,
                    totalWidth: totalWidth + 'px',
                    gridTemplate: widths.join(' '),
                    scrollbarWidth: scrollbarWidth
                };
                localStorage.setItem(storageKey, JSON.stringify(widthsData));
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ç–∏ —à–∏—Ä–∏–Ω—ã –∫ Grid
                stickyHeader.style.gridTemplateColumns = widthsData.gridTemplate;
                stickyInput.style.gridTemplateColumns = widthsData.gridTemplate;
                stickyHeader.style.width = widthsData.totalWidth;
                stickyInput.style.width = widthsData.totalWidth;
                
                console.log('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —à–∏—Ä–∏–Ω—ã:', widthsData.gridTemplate, '–°–∫—Ä–æ–ª–ª–±–∞—Ä:', scrollbarWidth + 'px');
            } else {
                // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                const savedWidthsData = localStorage.getItem(storageKey);
                
                if (savedWidthsData) {
                    try {
                        const widthsData = JSON.parse(savedWidthsData);
                        
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∫ Grid
                        stickyHeader.style.gridTemplateColumns = widthsData.gridTemplate;
                        stickyInput.style.gridTemplateColumns = widthsData.gridTemplate;
                        stickyHeader.style.width = widthsData.totalWidth;
                        stickyInput.style.width = widthsData.totalWidth;
                        
                        console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —à–∏—Ä–∏–Ω—ã:', widthsData.gridTemplate);
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤:', e);
                        // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
                        applyDefaultWidths();
                    }
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
                    applyDefaultWidths();
                }
            }
        }, 100);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
    function applyDefaultWidths() {
        const stickyHeader = document.querySelector('.sticky-header');
        const stickyInput = document.querySelector('.sticky-input');
        
        if (!stickyHeader || !stickyInput) return;
        
        const selectedTable = "{{ selected_table }}";
        
        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –∏–∑ CSS
        let defaultWidths, defaultTotalWidth;
        
        if (selectedTable === 'wildberries') {
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è Wildberries (‚Ññ + 14 –¥–∞–Ω–Ω—ã—Ö; –±–µ–∑ ¬´–î–µ–π—Å—Ç–≤–∏—è¬ª)
            defaultWidths =
                '23px 70px 105px 80px 75px 105px 80px 253px 50px 30px 68px 58px 68px 126px 111px';
            // –°—É–º–º–∞ ~ 1102px; –º–æ–∂–Ω–æ –æ–∫—Ä—É–≥–ª–∏—Ç—å
            defaultTotalWidth = '1105px';
        } else {
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è Yandex –∏ Ozon
            defaultWidths = '30px 80px 90px 80px 250px 70px 60px 90px 70px 100px 180px 80px';
            defaultTotalWidth = '1180px';
        }
        
        stickyHeader.style.gridTemplateColumns = defaultWidths;
        stickyInput.style.gridTemplateColumns = defaultWidths;
        stickyHeader.style.width = defaultTotalWidth;
        stickyInput.style.width = defaultTotalWidth;
        
        console.log('–ü—Ä–∏–º–µ–Ω–µ–Ω—ã —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —à–∏—Ä–∏–Ω—ã –¥–ª—è', selectedTable + ':', defaultWidths);
    }

    function applySavedWidths() {
        const stickyHeader = document.querySelector('.sticky-header');
        const stickyInput = document.querySelector('.sticky-input');
        const selectedTable = "{{ selected_table }}";
        const storageKey = `tableColumnWidths_${selectedTable}`;
        const saved = localStorage.getItem(storageKey);
        if (stickyHeader && stickyInput && saved) {
            try {
                const data = JSON.parse(saved);
                stickyHeader.style.gridTemplateColumns = data.gridTemplate;
                stickyInput.style.gridTemplateColumns = data.gridTemplate;
                stickyHeader.style.width = data.totalWidth;
                stickyInput.style.width = data.totalWidth;
            } catch(e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã');
            }
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    document.addEventListener('DOMContentLoaded', function() {
        applySavedWidths();
        syncColumnWidths();
        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        setTimeout(syncColumnWidths, 200);
        setTimeout(syncColumnWidths, 500);
        setTimeout(syncColumnWidths, 1000);
    });
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', syncColumnWidths);
    </script>
    <script>
    document.querySelectorAll('.delete-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const form = this.closest('form');
            const itemName = form.querySelector('input[name="item_name"]').value;

            Swal.fire({
                title: `–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${itemName}"?`,
                text: "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#aaa',
                confirmButtonText: '–î–∞, —É–¥–∞–ª–∏—Ç—å',
                cancelButtonText: '–û—Ç–º–µ–Ω–∞'
            }).then((result) => {
                if (result.isConfirmed) {
                    form.submit();
                }
            });
        });
    });
    </script>

    <script>
    document.querySelectorAll('.edit-btn').forEach(function(button) {
        button.addEventListener('click', function () {
            const row = this.closest('tr');
            isEditingRow = true;
            row.classList.add('highlighted');

            const table = "{{ selected_table }}";
            const headers = {{ table_data.columns.tolist() | tojson }};
            const cells = row.querySelectorAll('td');
            const indexOfArtMC = headers.indexOf("Sklad");
            const itemId = cells[indexOfArtMC].innerText.trim();


            const numericFields = ['–û–ø—Ç', '–¶–µ–Ω–∞', '%', '–ù–∞–ª'];
            const recalcPrices = () => {
                const optInput = row.querySelector('input[name="–û–ø—Ç"]');
                const markupInput = row.querySelector('input[name="%"]');

                const opt = parseFloat(optInput?.value.replace(/\s/g, ''));
                const markup = parseFloat(markupInput?.value.replace(/\s/g, ''));

                if (!isNaN(opt) && !isNaN(markup)) {
                    const newPrice = Math.round(opt + (opt * markup / 100));
                    ['–¶–µ–Ω–∞'].forEach(field => {
                        const td = row.querySelector(`td[data-price-target="${field}"]`);
                        if (td) {
                            td.innerText = newPrice.toLocaleString('ru-RU') + ' —Ä.';
                        }
                    });
                }
            };

            // –ó–∞–º–µ–Ω—è–µ–º td –Ω–∞ input'—ã
            for (let i = 0; i < headers.length; i++) {
                const td = cells[i];
                if (['–ú–æ–¥–µ–ª—å', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π'].includes(headers[i].trim())) {
                    td.classList.add('text-left');
                    td.classList.remove('text-center');
                } else {
                    td.classList.add('text-center');
                    td.classList.remove('text-left');
                }
                const val = td.innerText.trim();

                const skipInputFields = ['‚Ññ', 'Sklad', '–¶–µ–Ω–∞', '–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è'];

                if (!headers[i] || skipInputFields.includes(headers[i])) {
                    if (headers[i] === '–¶–µ–Ω–∞') {
                        td.setAttribute('data-price-target', '–¶–µ–Ω–∞');  // üí° –ü–æ–º–µ—á–∞–µ–º td –¥–ª—è JS-–ø–µ—Ä–µ—Å—á—ë—Ç–∞
                    }
                    continue;
                }
                td.style.width = td.offsetWidth + 'px';
                td.innerHTML = '';
                let input;
                if (headers[i] === '–ü–æ—Å—Ç–∞–≤—â–∏–∫') {
                    input = document.createElement('select');
                    input.name = '–ü–æ—Å—Ç–∞–≤—â–∏–∫';
                    ['','Sklad','United','Invask','Okno'].forEach(optVal => {
                        const option = document.createElement('option');
                        option.value = optVal;
                        option.textContent = optVal;
                        if (optVal === val) option.selected = true;
                        input.appendChild(option);
                    });
                } else if (headers[i] === '–°—Ç–∞—Ç—É—Å') {
                    input = document.createElement('select');
                    input.name = '–°—Ç–∞—Ç—É—Å';
                    ['','–≤—ã–∫–ª.'].forEach(optVal => {
                        const option = document.createElement('option');
                        option.value = optVal;
                        option.textContent = optVal;
                        if (optVal === val) option.selected = true;
                        input.appendChild(option);
                    });
                } else {
                    input = document.createElement('input');
                    if (headers[i] === '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π') {
                        td.classList.add('comment-cell');
                        input.style.minWidth = '210px';
                        input.style.maxWidth = '280px';
                    }
                    input.name = headers[i];
                    if (headers[i] === '–ù–∞–ª') {
                        const onoffSelect = row.querySelector('select[name="–°—Ç–∞—Ç—É—Å"]');
                        if (onoffSelect && onoffSelect.value === '–≤—ã–∫–ª.') {
                            input.value = '0';
                            input.disabled = true;
                        }
                    }
                    if (numericFields.includes(headers[i])) {
                        input.value = val.replace(/\s/g, '').replace('—Ä.', '').replace('%', '');
                    } else {
                        input.value = val;
                    }
                    input.style.width = '100%';
                    input.type = 'text';
                    if (numericFields.includes(headers[i])) {
                        input.inputMode = 'numeric';
                        input.pattern = '\\d*';
                        input.addEventListener('input', function () {
                            this.value = this.value.replace(/[^\d]/g, '');
                        });
                        input.addEventListener('paste', function (e) {
                            e.preventDefault();
                        });
                        input.addEventListener('drop', function (e) {
                            e.preventDefault();
                        });
                        if (['–û–ø—Ç', '%'].includes(headers[i])) {
                            input.addEventListener('input', recalcPrices);
                        }
                    }
                }
                td.appendChild(input);

            }
            const onoffSelect = row.querySelector('select[name="–°—Ç–∞—Ç—É—Å"]');
            const stockInput = row.querySelector('input[name="–ù–∞–ª"]');
            if (onoffSelect && stockInput) {
                onoffSelect.addEventListener('change', function () {
                    if (this.value === '–≤—ã–∫–ª.') {
                        stockInput.value = '0';
                        stockInput.disabled = true;
                    } else {
                        stockInput.disabled = false;
                    }
                });
            }
            // üõ°Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª submit –¥–≤–∞–∂–¥—ã
            const addBtn = document.querySelector('.sticky-input button[type="submit"]');
            if (addBtn) {
                addBtn.disabled = true;
                addBtn.style.opacity = "0.4";
                addBtn.style.cursor = "not-allowed";
                addBtn.title = "–°–Ω–∞—á–∞–ª–∞ –∑–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
            }
            // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—É
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/update/${table}/${itemId}`;
            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'Sklad';
            hiddenId.value = itemId;
            form.appendChild(hiddenId);
            form.style.display = 'inline';

            // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ENTER ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
            cells.forEach((td, i) => {
                const input = td.querySelector('input');
                if (!input) return;

                input.addEventListener('keydown', function (event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        form.requestSubmit();
                    }
                });
            });

            // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º submit: –¥–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
            form.addEventListener('submit', function (e) {
                e.preventDefault();

                let valid = true;
                let invalidFields = [];

                // üîß –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ hidden –ø–æ–ª—è, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
                form.querySelectorAll('input[type="hidden"]').forEach(el => el.remove());

                for (let i = 0; i < headers.length; i++) {
                    if (!headers[i] || headers[i] === '‚Ññ') continue;

                    const element = cells[i].querySelector('input, select');
                    if (element) {
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.name = headers[i];
                        let value = element.value.trim();

                        if (numericFields.includes(headers[i])) {
                            value = value.replace(/\s+/g, '').replace('—Ä.', '').replace('%', '').trim();
                            if (!value || !/^\d+$/.test(value)) {
                                valid = false;
                                invalidFields.push(headers[i]);
                            }
                        }

                        hidden.value = value;
                        form.appendChild(hidden);
                    }
                }

                if (!valid) {
                    Swal.fire({
                        icon: 'error',
                        title: '–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞',
                        text: '–ü–æ–ª—è: ' + invalidFields.join(', ') + ' –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏.',
                    });
                    return;
                }

                // üß† –°–æ—Ö—Ä–∞–Ω—è–µ–º scrollY –∏ Sklad
                localStorage.setItem("highlight_art", itemId);
                fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form)
                }).then(response => {
                    if (response.ok) {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
                            showConfirmButton: false,
                            timer: 1500
                        });
                        isEditingRow = false;
                        setTimeout(() => location.reload(), 500);
                    } else {
                        Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä', 'error');
                    }
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
                    Swal.fire('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö', 'error');
                });
            });
            const editBtn = row.querySelector('.edit-btn');
            if (editBtn) {
                const parentCell = editBtn.closest('td');

                // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫—É ‚úèÔ∏è
                editBtn.remove();

                // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É "–≥–∞–ª–æ—á–∫–∞"
                const saveBtn = document.createElement('button');
                saveBtn.type = 'submit';
                saveBtn.innerText = '‚úÖ';
                saveBtn.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                saveBtn.style = 'background:none; border:none; color:green; cursor:pointer; font-size:18px;';

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ —Ñ–æ—Ä–º—É
                form.appendChild(saveBtn);

                // –í—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –Ω–∞ –º–µ—Å—Ç–æ, –≥–¥–µ –±—ã–ª–∞ –∫–Ω–æ–ø–∫–∞ ‚úèÔ∏è
                parentCell.insertBefore(form, parentCell.firstChild);
            }
        });
    });
    </script>

    <script>
    window.addEventListener("DOMContentLoaded", function () {
        const y = localStorage.getItem("scrollY");
        const highlightId = localStorage.getItem("highlight_art");
        const selectedTable = "{{ selected_table }}";

        const highlightColors = {
            yandex: "#fdf7b2",
            ozon: "#d5e4ff",
            wildberries: "#efc1ed"
        };

        if (highlightId) {
            const tryScrollToRow = () => {
                const rows = document.querySelectorAll("tbody tr");
                const headers = {{ table_data.columns.tolist() | tojson }};
                const artIndex = headers.indexOf("Sklad");

                for (const row of rows) {
                    const cells = row.querySelectorAll("td");
                    const artValue = cells[artIndex]?.innerText.trim();
                    if (artValue === highlightId) {
                        row.classList.add("highlighted");
                        row.style.setProperty('--highlight-color', highlightColors[selectedTable] || "#fdf7b2");

                        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Å—Ç—Ä–æ–∫–µ
                        row.scrollIntoView({ behavior: "auto", block: "center" });
                        return true;
                    }
                }
                return false;
            };

            // ‚è≥ –ü—Ä–æ–±—É–µ–º –∂–¥–∞—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏
            let attempts = 0;
            const maxAttempts = 20;
            const interval = setInterval(() => {
                if (tryScrollToRow() || attempts++ > maxAttempts) {
                    clearInterval(interval);
                }
            }, 100);
        }

        if (highlightId) {
            const rows2 = document.querySelectorAll("tbody tr");
            const headers2 = {{ table_data.columns.tolist() | tojson }};
            const artIndex2 = headers2.indexOf("Sklad");

            rows2.forEach(row => {
                const cells = row.querySelectorAll("td");
                const artValue = cells[artIndex2]?.innerText.trim();
                if (artValue === highlightId) {
                    row.classList.add("highlighted");
                    row.style.setProperty('--highlight-color', highlightColors[selectedTable] || "#fdf7b2");
                }
            });

            // –ù–ï —É–¥–∞–ª—è–µ–º highlight_art ‚Äî –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è –±—É–¥—É—â–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
            // localStorage.removeItem("highlight_art");
        }
    });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const addForm = document.querySelector('form[action^="/add"]');
        if (!addForm) return;

        // ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        const requiredFields = ['Sklad', '–ú–æ–¥–µ–ª—å', '–ù–∞–ª', '–û–ø—Ç', '%'];

        // –î–ª—è Wildberries ‚Äî –æ–±–∞ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
        if ("{{ selected_table }}" === "wildberries") {
            requiredFields.push('WB Barcode', 'WB –ê—Ä—Ç–∏–∫—É–ª');
        }

        addForm.addEventListener("submit", function (e) {
            const formData = new FormData(addForm);
            let hasError = false;
            let missingFields = [];
            let invalidNumericFields = [];

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            requiredFields.forEach(field => {
                const value = (formData.get(field) || "").trim();
                if (!value) {
                    hasError = true;
                    missingFields.push(field);
                } else {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ–≤–æ–µ –ø–æ–ª–µ
                    if (['–ù–∞–ª', '–û–ø—Ç', '%', 'WB Barcode', 'WB –ê—Ä—Ç–∏–∫—É–ª', 'Sklad'].includes(field)) {
                        if (!/^\d+$/.test(value)) {
                            hasError = true;
                            invalidNumericFields.push(field);
                        }
                    }
                }
            });

            if (hasError) {
                e.preventDefault();
                let msg = "";
                if (missingFields.length > 0) {
                    msg += "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è:\n‚Ä¢ " + missingFields.join("\n‚Ä¢ ") + "\n";
                }
                if (invalidNumericFields.length > 0) {
                    msg += "–í –ø–æ–ª—è—Ö " + invalidNumericFields.join(", ") + " –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã.";
                }
                alert(msg);
            }
        });
    });
    </script>


    <script>
    document.getElementById('manual-update-btn')?.addEventListener('click', function () {
        const btn = this;
        btn.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ‚Ä¶";
        btn.style.pointerEvents = "none";
        btn.style.opacity = "0.6";

        fetch('/run_update', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∫–ª–∞–¥–∞.");
                btn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å";
                btn.style.pointerEvents = "";
                btn.style.opacity = "";
            }
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞:", err);
            alert("‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–∫–ª–∞–¥.");
            btn.textContent = "–û–±–Ω–æ–≤–∏—Ç—å";
            btn.style.pointerEvents = "";
            btn.style.opacity = "";
        });
    });
    </script>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const clickRows = document.querySelectorAll("tbody tr");
        const selectedTable = "{{ selected_table }}";

        let color = "#fdf7b2";  // Yandex –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (selectedTable === "ozon") color = "#d5e4ff";
        if (selectedTable === "wildberries") color = "#efc1ed";

        const clickHeaders = {{ table_data.columns.tolist() | tojson }};
        const clickArtIndex = clickHeaders.indexOf("Sklad");

        clickRows.forEach(row => {
            row.addEventListener("click", function () {
                if (isEditingRow) return; // üö´ –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

                const cells = this.querySelectorAll("td");
                const artValue = cells[clickArtIndex]?.innerText.trim();
                const isHighlighted = this.classList.contains("highlighted");

                // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
                clickRows.forEach(r => r.classList.remove("highlighted"));

                if (!isHighlighted) {
                    this.classList.add("highlighted");
                    this.style.setProperty('--highlight-color', color);
                    if (artValue) {
                        localStorage.setItem("highlight_art", artValue);
                    }
                } else {
                    localStorage.removeItem("highlight_art");
                }
            });
        });
    });
    </script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll("td.text-left").forEach(td => {
            if (td.scrollWidth > td.clientWidth) {
                td.setAttribute("title", td.textContent.trim());
            }
        });
    });
    </script>

    {% if request.args.get('duplicate') %}
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            Swal.fire({
                icon: 'error',
                title: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è',
                text: '–¢–æ–≤–∞—Ä —Å —Ç–∞–∫–∏–º Sklad, –ê—Ä—Ç–∏–∫—É–ª, –ú–æ–¥–µ–ª—å, WB Barcode –∏–ª–∏ WB –ê—Ä—Ç–∏–∫—É–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.'
            }).then(() => {
                // —É–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä duplicate –∏–∑ URL
                const url = new URL(window.location.href);
                url.searchParams.delete('duplicate');
                window.history.replaceState({}, document.title, url.pathname + url.search);
            });
        });
    </script>
    {% endif %}

<script>
let isEditingRow = false;
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("custom-search");
  const clearBtn = document.getElementById("clear-search-new");
  const form = input.closest("form");

  if (!input || !clearBtn || !form) return;

  const toggleClearBtn = () => {
    if (input.value.trim()) {
      clearBtn.style.display = "block";
    } else {
      clearBtn.style.display = "none";
    }
  };

  // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å/—Å–∫—Ä—ã–≤–∞—Ç—å –∫—Ä–µ—Å—Ç–∏–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ
  input.addEventListener("input", toggleClearBtn);
  toggleClearBtn(); // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

  // –ö–ª–∏–∫ –ø–æ –∫—Ä–µ—Å—Ç–∏–∫—É ‚Äî –æ—á–∏—Å—Ç–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
  clearBtn.addEventListener("click", function () {
    input.value = "";
    toggleClearBtn();
    form.submit();  // —Å–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–∞
  });

  // –ù–∞–∂–∞—Ç–∏–µ Enter ‚Äî –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞
  input.addEventListener("keydown", function (event) {
    if (event.key === "Enter") {
      event.preventDefault();
      form.submit();
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".letter-filter a").forEach(link => {
        link.addEventListener("click", function (e) {
            const currentLetter = new URLSearchParams(window.location.search).get("letter");
            const thisLetter = this.textContent.trim();

            if (currentLetter === thisLetter) {
                e.preventDefault();
                const url = new URL(window.location.href);
                url.searchParams.delete("letter");
                window.location.href = url.toString(); // ‚ùå —Å–Ω–∏–º–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
            }
        });
    });
});
</script>
<script>
  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º scrollY –ø–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  window.addEventListener("beforeunload", function () {
      localStorage.setItem("scrollY", window.scrollY);
  });

  // –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º scrollY –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
  window.addEventListener("DOMContentLoaded", function () {
      const savedScrollY = localStorage.getItem("scrollY");
      if (savedScrollY !== null) {
          window.scrollTo(0, parseInt(savedScrollY));
          localStorage.removeItem("scrollY");  // –æ—á–∏—â–∞–µ–º –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("thead th a").forEach(link => {
        link.addEventListener("click", function () {
            // –ü—Ä–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ ‚Äî –æ—á–∏—â–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            localStorage.removeItem("highlight_art");
        });
    });
});
</script>

<script>
document.getElementById('run-unlisted-btn')?.addEventListener('click', function () {
    const btn = this;
    btn.disabled = true;

    fetch('/run_unlisted')
        .then(response => {
            if (response.ok) {
                showCustomAlert("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: not_listed.xlsx");
            } else {
                showCustomAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞", true);
            }
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞:", err);
            showCustomAlert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞", true);
        })
        .finally(() => {
            btn.disabled = false;
        });
});

function showCustomAlert(message, isError = false) {
    const alertBox = document.getElementById('custom-alert');
    alertBox.textContent = message;
    alertBox.style.backgroundColor = isError ? '#f8d7da' : '#d4edda';
    alertBox.style.color = isError ? '#721c24' : '#155724';
    alertBox.style.borderColor = isError ? '#f5c6cb' : '#c3e6cb';
    alertBox.style.display = 'block';

    setTimeout(() => {
        alertBox.style.display = 'none';
    }, 3000);
}
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏ –ø–æ–∏—Å–∫–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    const searchInput = document.getElementById("custom-search");
    if (searchInput) {
        searchInput.addEventListener("input", function () {
            localStorage.setItem("savedSearch", this.value.trim());
        });
    }

    // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –±—É–∫–≤—É ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    document.querySelectorAll(".letter-filter a").forEach(link => {
        link.addEventListener("click", function () {
            const letter = this.textContent.trim();
            const isActive = this.classList.contains("active");
            if (isActive) {
                localStorage.removeItem("savedLetter");
            } else {
                localStorage.setItem("savedLetter", letter);
            }
        });
    });


});
</script>

<!-- –ö–∞—Å—Ç–æ–º–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
<div id="custom-alert" style="
    display: none;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #d4edda;
    color: #155724;
    padding: 12px 20px;
    border: 1px solid #c3e6cb;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 9999;
    font-size: 16px;
    pointer-events: none;
    width: fit-content;
">
    –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!
</div>
{% if request.args.get('added') %}
<script>
    sessionStorage.removeItem('add_form_data');
</script>
{% endif %}

<script>
// –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞—Ö–æ–¥ –Ω–∞ —Å–∞–π—Ç (–Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è) ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
(function () {
    const sessionKey = 'session_start';
    const highlightKey = 'highlight_art';

    // –ü—Ä–æ–≤–µ—Ä–∏–º: –µ—Å–ª–∏ sessionStorage –µ—â—ë –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–∞, –∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞—Ö–æ–¥
    if (!sessionStorage.getItem(sessionKey)) {
        sessionStorage.setItem(sessionKey, '1');
        localStorage.removeItem(highlightKey);  // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
        console.log('[highlight] –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è ‚Äî –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ');
    } else {
        console.log('[highlight] –°–µ—Å—Å–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è ‚Äî –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º');
    }
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("custom-search");
    const clearBtn = document.getElementById("clear-search");

    function toggleClear() {
        clearBtn.style.display = searchInput.value ? "block" : "none";
    }

    searchInput.addEventListener("input", toggleClear);
    clearBtn.addEventListener("click", function () {
        searchInput.value = "";
        searchInput.form.submit();
    });

    toggleClear();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const searchInput = document.getElementById("custom-search");

  // —Å–æ–±—ã—Ç–∏–µ "search" —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∫—Ä–µ—Å—Ç–∏–∫
  searchInput.addEventListener("search", function() {
    if (!searchInput.value) {
      // –æ—á–∏—â–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä search –∏ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
      const url = new URL(window.location.href);
      url.searchParams.delete("search");
      window.location.href = url.toString();
    }
  });
});
</script>

<script>
(function(){
  // ‚Äî‚Äî‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM ‚Äî‚Äî‚Äî
  const $overlay = document.getElementById('screen-overlay');
  const $title   = document.getElementById('overlay-title');
  const $note    = document.getElementById('overlay-note');

  let BUSY = false;   // –ø—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤

  function showOverlay(title, note){
    if (title) $title.textContent = title;
    if (note)  $note.textContent  = note;
    $overlay.removeAttribute('hidden');
    document.body.style.cursor = 'progress';
  }
  function hideOverlay(){
    $overlay.setAttribute('hidden','');
    document.body.style.cursor = '';
  }

  // –ß–µ–ª–æ–≤–µ—á–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏
  const MP_LABELS = { yandex: 'Yandex', ozon: 'Ozon', wildberries: 'Wildberries' };

  // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π fetch JSON
  async function postJSON(url){
    const res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With':'XMLHttpRequest' } });
    // –¥–∞–∂–µ –ø—Ä–∏ 204 –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–µ –ø–∞–¥–∞—Ç—å
    let data = null;
    try { data = await res.json(); } catch(e){ data = null; }
    if (!res.ok || !data || data.status !== 'ok'){
      const msg = (data && data.message) ? data.message : `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  // ‚Äî‚Äî‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî‚Äî‚Äî
  async function handleToggle(input){
    if (BUSY) { input.checked = !input.checked; return; } // –æ—Ç–º–µ–Ω—è–µ–º –ø–æ–≤—Ç–æ—Ä
    BUSY = true;
    // –æ—Ç–∫–ª—é—á–∏–º —Ç—É–º–±–ª–µ—Ä—ã, —á—Ç–æ–±—ã –Ω–µ ¬´–¥—Ä–µ–±–µ–∑–∂–∞–ª–∏¬ª
    document.querySelectorAll('.global-toggle, .supplier-toggle').forEach(el => el.disabled = true);

    const isMarketToggle   = input.classList.contains('global-toggle');
    const isSupplierToggle = input.classList.contains('supplier-toggle');

    try {
      if (isMarketToggle){
        const market = (input.dataset.market || '').toLowerCase();
        const label  = MP_LABELS[market] || market;
        const mode   = input.checked ? '–í–∫–ª—é—á–µ–Ω–∏–µ' : '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ';
        showOverlay(`${mode} –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞: ${label}`, '–ò–¥—ë—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫‚Ä¶');
        const data = await postJSON(`/toggle_stock/${encodeURIComponent(market)}`);
        // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–∫—Ç–æ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        input.checked = !!data.enabled;

      } else if (isSupplierToggle){
        const supplier = (input.dataset.supplier || '').trim();
        const mode     = input.checked ? '–í–∫–ª—é—á–µ–Ω–∏–µ' : '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ';
        showOverlay(`${mode} –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: ${supplier}`, '–ò–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤‚Ä¶');
        const data = await postJSON(`/toggle_supplier/${encodeURIComponent(supplier)}`);
        input.checked = !!data.enabled;
      }

    } catch(err){
      // –æ—Ç–∫–∞—Ç–∏—Ç—å —Ñ–ª–∞–∂–æ–∫, –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
      input.checked = !input.checked;
      Swal.fire('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è', String(err.message || err), 'error');

    } finally {
      hideOverlay();
      BUSY = false;
      document.querySelectorAll('.global-toggle, .supplier-toggle').forEach(el => el.disabled = false);
      // –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏ —à–∞–ø–∫–∏
      location.reload();
    }
  }

  // ‚Äî‚Äî‚Äî –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ —Ä–∞–Ω—å—à–µ –≤—Å–µ—Ö (capture: true), –≥–∞—Å–∏—Ç —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ ‚Äî‚Äî‚Äî
  document.addEventListener('change', function(e){
    const t = e.target;
    if (!t) return;
    if (t.matches('.global-toggle, .supplier-toggle')){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      handleToggle(t);
    }
  }, true); // ‚¨Ö capture:true

  // ‚Äî‚Äî‚Äî –±–ª–æ–∫–∏—Ä—É–µ–º –ª—é–±—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é, –ø–æ–∫–∞ BUSY (–∫–ª–∏–∫–∏ –ø–æ –≤–∫–ª–∞–¥–∫–∞–º/–∞–ª—Ñ–∞–≤–∏—Ç—É/—Å—Å—ã–ª–∫–∞–º) ‚Äî‚Äî‚Äî
  document.addEventListener('click', function(e){
    if (!BUSY) return;
    const a = e.target.closest('a');
    if (a){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
    }
  }, true);
})();
</script>

<script>
(function() {
  const supplierCols = ['Sklad', 'Invask', 'Okno', 'United'];
  const headers = {{ table_data.columns.tolist() | tojson }};
  const idx = {};
  headers.forEach((h, i) => idx[h] = i);

  // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —è—á–µ–π–∫–∞–º –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤
  document.querySelectorAll('.main-table tbody tr').forEach(tr => {
    supplierCols.forEach(col => {
      const colIdx = idx[col];
      if (typeof colIdx !== 'number') return;
      const td = tr.children[colIdx];
      if (!td) return;

      td.style.cursor = 'pointer'; // –∫—É—Ä—Å–æ—Ä "—Ä—É–∫–∞"

      td.addEventListener('click', (e) => {
        const val = td.innerText.trim();
        if (val) {
          navigator.clipboard.writeText(val).then(() => {
            // –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—à–∫—É –æ–∫–æ–ª–æ –∫—É—Ä—Å–æ—Ä–∞
            const tooltip = document.getElementById('copy-tooltip');
            tooltip.textContent = `—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ${val}`;
            tooltip.style.left = (e.clientX + 10) + 'px';
            tooltip.style.top = (e.clientY + 10) + 'px';
            tooltip.style.opacity = '1';

            // —Å–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
              tooltip.style.opacity = '0';
            }, 1000);
          }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
          });
        }
      });
    });
  });
})();
</script>
<script>
(function(){
  // ‚Äî‚Äî‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM ‚Äî‚Äî‚Äî
  const $overlay = document.getElementById('screen-overlay');
  const $title   = document.getElementById('overlay-title');
  const $note    = document.getElementById('overlay-note');

  let BUSY = false;   // –ø—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤

  function showOverlay(title, note){
    if (title) $title.textContent = title;
    if (note)  $note.textContent  = note;
    $overlay.removeAttribute('hidden');
  }
  function hideOverlay(){
    $overlay.setAttribute('hidden','');
  }

  // –ß–µ–ª–æ–≤–µ—á–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏
  const MP_LABELS = { yandex: 'Yandex', ozon: 'Ozon', wildberries: 'Wildberries' };

  // –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π fetch JSON
  async function postJSON(url){
    const res = await fetch(url, { method: 'POST', headers: { 'X-Requested-With':'XMLHttpRequest' } });
    // –¥–∞–∂–µ –ø—Ä–∏ 204 –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –Ω–µ –ø–∞–¥–∞—Ç—å
    let data = null;
    try { data = await res.json(); } catch(e){ data = null; }
    if (!res.ok || !data || (data.status && data.status !== 'ok')){
      const msg = (data && data.message) ? data.message : `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  // ‚Äî‚Äî‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ ‚Äî‚Äî‚Äî
  async function handleToggle(input){
    if (BUSY) { input.checked = !input.checked; return; } // –æ—Ç–º–µ–Ω—è–µ–º –ø–æ–≤—Ç–æ—Ä
    BUSY = true;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å: –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –∏–ª–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫
    const isMarketToggle   = input.classList.contains('global-toggle');
    const isSupplierToggle = input.classList.contains('supplier-toggle');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π —Å –ø–æ–Ω—è—Ç–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
    if (isMarketToggle){
      const market = (input.dataset.market || '').toLowerCase();
      const label  = MP_LABELS[market] || market;
      const mode   = input.checked ? '–í–∫–ª—é—á–µ–Ω–∏–µ' : '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ';
      showOverlay(`${mode} –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞: ${label}`, '–ò–¥—ë—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫‚Ä¶');
      try {
        const data = await postJSON(`/toggle_stock/${encodeURIComponent(market)}`);
        // —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∞–∫—Ç–æ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
        input.checked = !!data.enabled;
      } catch(err){
        // –æ—Ç–∫–∞—Ç–∏—Ç—å —Ñ–ª–∞–∂–æ–∫, –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        input.checked = !input.checked;
        Swal.fire('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è', String(err.message || err), 'error');
      } finally {
        hideOverlay();
        BUSY = false;
        // –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏ —à–∞–ø–∫–∏
        location.reload();
      }
      return;
    }

    if (isSupplierToggle){
      const supplier = (input.dataset.supplier || '').trim();
      const mode     = input.checked ? '–í–∫–ª—é—á–µ–Ω–∏–µ' : '–û—Ç–∫–ª—é—á–µ–Ω–∏–µ';
      showOverlay(`${mode} –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: ${supplier}`, '–ò–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤‚Ä¶');
      try {
        const data = await postJSON(`/toggle_supplier/${encodeURIComponent(supplier)}`);
        input.checked = !!data.enabled;
      } catch(err){
        input.checked = !input.checked;
        Swal.fire('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è', String(err.message || err), 'error');
      } finally {
        hideOverlay();
        BUSY = false;
        location.reload();
      }
      return;
    }
  }

  // ‚Äî‚Äî‚Äî –Ω–∞–≤–µ—à–∏–≤–∞–µ–º –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ —Ä–∞–Ω—å—à–µ –≤—Å–µ—Ö (capture: true), —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º ‚Äî‚Äî‚Äî
  document.addEventListener('change', function(e){
    const t = e.target;
    if (!t) return;
    if (t.matches('.global-toggle, .supplier-toggle')){
      // –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∏ –≥–∞—Å–∏–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Å—Ç–∞—Ä—ã–º–∏ —Å–ª—É—à–∞—Ç–µ–ª—è–º–∏
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      // –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—à –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
      handleToggle(t);
    }
  }, true); // ‚¨Ö capture:true
})();
</script>

</body>
</html>
